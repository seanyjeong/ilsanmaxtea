<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>학생 공지사항 관리 (관리자)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 기존 관리자 페이지 스타일 변수 재활용 */
        :root {
            --primary-color: #2563eb; --primary-dark:#1d4ed8;
            --light-bg: #f8fafc; --card-bg: #ffffff;
            --border-color: #e2e8f0; --text-primary:#1e293b; --text-secondary:#475569;
            --danger-color: #ef4444; --success-color: #10b981; --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light-bg); padding: 20px; margin: 0; line-height: 1.5; color: var(--text-primary); }
        .container { max-width: 900px; margin: 0 auto; }

        /* ---------- Header ---------- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            gap: 12px; flex-wrap: wrap;
            background: var(--card-bg); padding: 16px 18px; border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.6rem; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: none; border-radius: 8px; font-weight: 600; font-size: .9rem; cursor: pointer; transition: .2s; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; }
        .btn-danger { background: var(--danger-color); color: #fff; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: #e2e8f0; color: var(--text-secondary); }
        .btn-secondary:hover { background: #cbd5e1; }

        /* ---------- Card ---------- */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
        .card-title { font-size: 1.3rem; font-weight: 600; margin: 0 0 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }

        /* 폼 요소 */
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .form-group label { font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary); }
        .form-group input[type="text"], .form-group select, .form-group textarea {
            width: 100%; padding: 10px; font-size: 0.95rem;
            border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Pretendard', sans-serif;
        }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }

        /* 공지사항 목록 */
        #announcementList { list-style: none; padding: 0; margin: 0; }
        .announcement-item {
            background: #f8fafc; border: 1px solid var(--border-color);
            border-radius: 8px; padding: 15px; margin-bottom: 15px;
        }
        .announcement-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed var(--border-color);
        }
        .announcement-title { font-size: 1.1rem; font-weight: 600; margin: 0; flex-grow: 1; }
        .announcement-meta { font-size: 0.8rem; color: var(--text-secondary); text-align: right; white-space: nowrap; margin-left: 15px; }
        .announcement-meta .branch { font-weight: 600; color: var(--primary-color); display: block; }
        .announcement-meta .date { display: block; margin-top: 3px; }
        .announcement-meta .author { font-size: 0.75rem; display: block; margin-top: 3px; } /* 스타일 살짝 변경 */
        .announcement-content { font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap; word-break: break-word; margin-bottom: 15px; }
        .announcement-actions { display: flex; justify-content: flex-end; gap: 8px; }

        /* 로딩/데이터 없음 */
        .loading, .no-data { text-align: center; padding: 30px; color: var(--text-secondary); }

        /* --- Toast Popup --- */
        .toast-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8); color: white; padding: 10px 18px; border-radius: 20px;
            font-size: 0.9rem; z-index: 1002; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
            pointer-events: none;
        }
        .toast-popup.show { opacity: 1; bottom: 40px; }
        .toast-popup.success { background-color: var(--success-color); }
        .toast-popup.error { background-color: var(--danger-color); }

        /* --- 모바일 반응형 --- */
        @media (max-width: 767px) {
            body { padding: 10px; }
            .header { flex-direction: column; align-items: stretch; padding: 15px; }
            .header h1 { font-size: 1.4rem; }
            .btn { justify-content: center; }
            .card { padding: 15px; }
            .announcement-header { flex-direction: column; align-items: stretch; }
            .announcement-meta { text-align: left; margin-left: 0; margin-top: 8px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-bullhorn"></i> 학생 공지사항 관리</h1>
    </div>

    <div class="card" id="announcementFormCard">
        <h4 class="card-title" id="formTitle">새 공지사항 작성</h4>
        <input type="hidden" id="editingNoticeId">
        <div class="form-group">
            <label for="noticeTitle">제목 (필수)</label>
            <input type="text" id="noticeTitle" placeholder="공지 제목을 입력하세요">
        </div>
        <div class="form-group">
            <label for="noticeContent">내용</label>
            <textarea id="noticeContent" rows="5" placeholder="공지 내용을 입력하세요..."></textarea>
        </div>
        <div class="form-group">
            <label for="noticeBranch">대상 지점</label>
            <select id="noticeBranch">
                <option value="">- 전체 학생 -</option>
            </select>
        </div>
        <div class="form-actions">
            <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display: none;">취소</button>
            <button type="button" id="saveNoticeBtn" class="btn btn-primary">
                <i class="fas fa-save"></i> 저장하기
            </button>
        </div>
    </div>

    <div class="card">
        <h4 class="card-title">공지 목록</h4>
        <div id="announcementList">
            <p class="loading" id="listLoading"><i class="fas fa-spinner fa-spin"></i> 목록 로딩 중...</p>
        </div>
    </div>
</div>

<template id="announcementItemTemplate">
    <div class="announcement-item" data-notice-id="{{notice_id}}">
        <div class="announcement-header">
            <h5 class="announcement-title">공지 제목</h5>
            <div class="announcement-meta">
                <span class="branch">대상: 전체</span>
                <span class="date">작성일: YYYY-MM-DD HH:MM</span>
                <span class="author">(작성자: 아이디)</span> </div>
        </div>
        <div class="announcement-content">
            공지 내용이 여기에 표시됩니다.
        </div>
        <div class="announcement-actions">
            <button type="button" class="btn btn-secondary btn-sm edit-btn">
                <i class="fas fa-edit"></i> 수정
            </button>
            <button type="button" class="btn btn-danger btn-sm delete-btn">
                <i class="fas fa-trash"></i> 삭제
            </button>
        </div>
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 서버 및 인증 ---
        const SVR_JUNGSI = 'https://supermax.kr'; // jungsi 서버
        const LOGIN_PAGE = 'admin_login.html'; // 관리자 로그인 페이지

        // --- HTML 요소 ---
        const announcementFormCard = document.getElementById('announcementFormCard');
        const formTitle = document.getElementById('formTitle');
        const editingNoticeId = document.getElementById('editingNoticeId');
        const noticeTitle = document.getElementById('noticeTitle');
        const noticeContent = document.getElementById('noticeContent');
        const noticeBranch = document.getElementById('noticeBranch');
        const saveNoticeBtn = document.getElementById('saveNoticeBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const announcementList = document.getElementById('announcementList');
        const listLoading = document.getElementById('listLoading');

        let currentUser = null; // 로그인한 사용자 정보
        let branchList = []; // 지점 목록 (sean8320 전용)

        // --- 인증 확인 ---
        const getToken = () => localStorage.getItem('jwt_token');
        const token = getToken();
        if (!token) { alert('로그인이 필요합니다.'); window.location.href = LOGIN_PAGE; return; }
        try {
            const payloadBase64Url = token.split('.')[1];
            const payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
            const decodedString = new TextDecoder().decode(Uint8Array.from(atob(payloadBase64), c => c.charCodeAt(0)));
            currentUser = JSON.parse(decodedString);
            console.log("로그인 사용자:", currentUser);
        } catch (e) {
            console.error('토큰 처리 실패:', e); alert('인증 정보 오류.'); window.location.href = LOGIN_PAGE; return;
        }

        // --- API 호출 함수 (인증 포함, 403 처리 수정) ---
        const apiCall = async (url, options = {}) => {
            const currentToken = getToken();
            if (!currentToken) { alert('로그인 세션 만료'); window.location.href = LOGIN_PAGE; throw new Error('로그인 만료'); }
            options.headers = { ...options.headers, 'Authorization': `Bearer ${currentToken}` };
            try {
                const response = await fetch(url, options);
                if (response.status === 401) {
                     alert('로그인 세션이 만료되었습니다. 다시 로그인해주세요.');
                     localStorage.removeItem('jwt_token');
                     window.location.href = LOGIN_PAGE;
                     throw new Error('로그인 만료');
                } else if (response.status === 403) {
                     alert('이 기능에 접근할 권한이 없습니다.');
                     throw new Error('권한 없음');
                }
                if (!response.ok) {
                    let errorMsg = `HTTP 오류 ${response.status}`; try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch (_) {} throw new Error(errorMsg);
                }
                if (response.status === 204) { return { success: true }; }
                 return await response.json();
            } catch (error) {
                console.error('API 호출 실패:', url, error);
                if (error.message !== '로그인 만료' && error.message !== '권한 없음') {
                    showToast(`네트워크 또는 서버 오류: ${error.message}`, false);
                    throw new Error(error.message || '네트워크 오류');
                }
                throw error;
            }
        };

        // --- Toast Popup 함수 ---
        const showToast = (message, isSuccess = true) => {
            const el = document.createElement('div'); el.textContent = message; el.className = `toast-popup ${isSuccess ? 'success' : 'error'}`; document.body.appendChild(el); setTimeout(() => el.classList.add('show'), 10); setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 2500);
        };

        // --- 날짜 포맷팅 헬퍼 ---
        const formatDateTime = (isoString) => {
            if (!isoString) return ''; try { const date = new Date(isoString); return date.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(/\. /g, '-').replace('.', ''); } catch (e) { return isoString; }
        };

        // --- 최상위 관리자인지 확인하는 함수 (sean8320만) ---
        const isSuperAdmin = () => {
            return currentUser && currentUser.userid === 'sean8320';
        }
        // --- 일반 관리 권한 확인 함수 (원장/부원장/팀장 또는 sean8320) ---
        const hasGeneralAdminPermission = () => {
             return currentUser && (
                (currentUser.position && ['원장', '부원장', '팀장'].includes(currentUser.position)) ||
                currentUser.role === 'admin' ||
                currentUser.userid === 'sean8320'
            );
        }

        // --- 1. 지점 목록 로드 및 설정 (sean8320만 전체 로드) ---
        const loadBranchesAndSetupDropdown = async () => {
            const isSean = isSuperAdmin();
            const loggedInBranch = currentUser ? currentUser.branch : null;
            console.log('loadBranches: isSuperAdmin =', isSean, ', loggedInBranch =', loggedInBranch);
            noticeBranch.innerHTML = '';

            if (isSean) {
                noticeBranch.disabled = false;
                console.log(' -> sean8320: 전체 지점 목록 로드 시도');
                const allOption = document.createElement('option');
                allOption.value = "";
                allOption.textContent = "- 전체 학생 -";
                noticeBranch.appendChild(allOption);
                try {
                    const data = await apiCall(`${SVR_JUNGSI}/jungsi/admin/student-branches`);
                    if (data.success && Array.isArray(data.branches)) {
                        const branchNames = data.branches.sort();
                        branchList = branchNames;
                        branchNames.forEach(branchName => {
                            const option = document.createElement('option');
                            option.value = branchName;
                            option.textContent = branchName;
                            noticeBranch.appendChild(option);
                        });
                        console.log(' -> sean8320: 지점 목록 로드 완료:', branchList);
                        if (loggedInBranch) noticeBranch.value = loggedInBranch;
                        else noticeBranch.value = "";
                    } else {
                        showToast('전체 지점 목록 로드 실패', false);
                        console.error('API 응답 오류:', data);
                    }
                } catch (err) {
                    console.error('loadBranches sean8320 error caught:', err.message);
                     if (loggedInBranch) {
                         const option = document.createElement('option');
                         option.value = loggedInBranch;
                         option.textContent = loggedInBranch;
                         noticeBranch.appendChild(option);
                         noticeBranch.value = loggedInBranch;
                     } else { noticeBranch.value = ""; }
                }
            } else {
                noticeBranch.disabled = true;
                branchList = [];
                if (loggedInBranch) {
                    const option = document.createElement('option');
                    option.value = loggedInBranch;
                    option.textContent = loggedInBranch;
                    noticeBranch.appendChild(option);
                    noticeBranch.value = loggedInBranch;
                    console.log(` -> 일반 사용자: 대상 지점을 '${loggedInBranch}'(으)로 고정`);
                } else {
                    console.warn(' -> 일반 사용자: 지점 정보가 없어 대상 지점 설정 불가. 전체 공지만 가능.');
                     const allOption = document.createElement('option');
                     allOption.value = "";
                     allOption.textContent = "- 전체 학생 -";
                     noticeBranch.appendChild(allOption);
                     noticeBranch.value = "";
                }
            }
             resetForm();
        };

        // --- 2. 공지사항 목록 로드 및 렌더링 ---
        const loadAnnouncements = async () => {
            listLoading.style.display = 'block';
            announcementList.innerHTML = '';
            announcementList.appendChild(listLoading);
            try {
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/student/announcements`);
                listLoading.style.display = 'none';
                if (data.success && data.announcements) {
                    if (data.announcements.length === 0) {
                        announcementList.innerHTML = '<p class="no-data">작성된 공지사항이 없습니다.</p>';
                        return;
                    }
                    data.announcements.forEach(notice => {
                        const item = createAnnouncementItem(notice);
                        announcementList.appendChild(item);
                    });
                } else {
                    announcementList.innerHTML = `<p class="no-data">공지 목록 로드 실패: ${data.message || '오류'}</p>`;
                }
            } catch (err) {
                 listLoading.style.display = 'none';
                 console.error('loadAnnouncements error caught:', err.message);
            }
        };

        // --- 2-1. 개별 공지 항목 생성 함수 (작성자 표시 수정) ---
 // --- 2-1. 개별 공지 항목 생성 함수 (작성자 이름 표시) ---
        const createAnnouncementItem = (notice) => {
            const template = document.getElementById('announcementItemTemplate');
            const item = template.content.cloneNode(true).firstElementChild;
            item.dataset.noticeId = notice.notice_id;
            item.dataset.noticeData = JSON.stringify(notice); // 수정 시 사용

            item.querySelector('.announcement-title').textContent = notice.title;
            item.querySelector('.announcement-content').textContent = notice.content || '(내용 없음)';
            item.querySelector('.announcement-meta .branch').textContent = `대상: ${notice.branch_name || '전체'}`;
            item.querySelector('.announcement-meta .date').textContent = `작성일: ${formatDateTime(notice.created_at)}`;

            // ▼▼▼ 작성자 이름 표시 로직 수정 ▼▼▼
            const authorSpan = item.querySelector('.announcement-meta .author');
            const authorId = notice.created_by || '알수없음';
            const authorName = notice.author_name; // ⭐️ 백엔드에서 받아온 이름 사용
            let authorDisplayText = '';

            if (authorId === 'sean8320') {
                authorDisplayText = '일산맥스원장(운영자)';
            } else if (authorName) { // ⭐️ 이름 정보가 있으면 이름을 사용
                authorDisplayText = `${authorName} 선생님`;
            } else if (authorId !== '알수없음') { // 이름 정보는 없지만 아이디는 있으면 아이디 사용 (Fallback)
                authorDisplayText = `${authorId} 선생님`;
            } else {
                authorDisplayText = '알수없음';
            }
            authorSpan.textContent = `(작성자: ${authorDisplayText})`;
            // ▲▲▲ 작성자 이름 표시 로직 수정 끝 ▲▲▲

            // 수정/삭제 버튼 권한 (기존과 동일)
            if (hasGeneralAdminPermission()) {
                item.querySelector('.edit-btn').addEventListener('click', () => startEditAnnouncement(notice));
                item.querySelector('.delete-btn').addEventListener('click', () => deleteAnnouncement(notice.notice_id, notice.title));
            } else {
                item.querySelector('.announcement-actions').style.display = 'none';
            }
            return item;
        };


        // --- 3. 새 공지사항 저장 ---
        const saveNewAnnouncement = async () => {
            const isSean = isSuperAdmin();
            const title = noticeTitle.value.trim();
            const content = noticeContent.value.trim();
            const branch = isSean ? noticeBranch.value : (currentUser?.branch || "");

            if (!title) { showToast('공지 제목을 입력하세요.', false); noticeTitle.focus(); return; }

            saveNoticeBtn.disabled = true;
            saveNoticeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 저장 중...';
            try {
                // 백엔드 API 호출 (권한 체크는 백엔드에서)
                await apiCall(`${SVR_JUNGSI}/jungsi/admin/student-announcements/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        target_branch: branch || null
                    })
                });
                showToast('✅ 새 공지사항이 등록되었습니다.', true);
                resetForm();
                loadAnnouncements();
            } catch (err) {
                 console.error('saveNewAnnouncement error caught:', err.message);
            } finally {
                 saveNoticeBtn.disabled = false;
                 saveNoticeBtn.innerHTML = '<i class="fas fa-save"></i> 저장하기';
            }
        };

        // --- 4. 공지사항 수정 시작 ---
        const startEditAnnouncement = (notice) => {
            if (!hasGeneralAdminPermission()) { showToast('공지사항 수정 권한이 없습니다.', false); return; }

            formTitle.textContent = '공지사항 수정';
            editingNoticeId.value = notice.notice_id;
            noticeTitle.value = notice.title;
            noticeContent.value = notice.content || '';
            noticeBranch.value = notice.branch_name || '';
            noticeBranch.disabled = !isSuperAdmin(); // sean8320만 지점 변경 가능
            saveNoticeBtn.innerHTML = '<i class="fas fa-edit"></i> 수정 완료';
            cancelEditBtn.style.display = 'inline-flex';
            announcementFormCard.scrollIntoView({ behavior: 'smooth' });
        };

        // --- 5. 공지사항 수정 저장 ---
        const saveEditedAnnouncement = async () => {
            const noticeId = editingNoticeId.value;
            if (!hasGeneralAdminPermission()) { showToast('공지사항 수정 권한이 없습니다.', false); return; }

            const title = noticeTitle.value.trim();
            const content = noticeContent.value.trim();
            const branch = isSuperAdmin() ? noticeBranch.value : (currentUser?.branch || "");

            if (!noticeId) { showToast('수정할 공지 ID가 없습니다.', false); return; }
            if (!title) { showToast('공지 제목을 입력하세요.', false); noticeTitle.focus(); return; }

            saveNoticeBtn.disabled = true;
            saveNoticeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 수정 중...';
            try {
                // 백엔드 API 호출 (권한 체크는 백엔드에서)
                await apiCall(`${SVR_JUNGSI}/jungsi/admin/student-announcements/update/${noticeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        target_branch: branch || null
                    })
                });
                showToast('✅ 공지사항이 수정되었습니다.', true);
                resetForm();
                loadAnnouncements();
            } catch (err) {
                 console.error('saveEditedAnnouncement error caught:', err.message);
            } finally {
                 saveNoticeBtn.disabled = false;
                 // resetForm에서 버튼 텍스트 복구됨
            }
        };

        // --- 6. 공지사항 삭제 ---
        const deleteAnnouncement = async (noticeId, title) => {
            if (!hasGeneralAdminPermission()) { showToast('공지사항 삭제 권한이 없습니다.', false); return; }
            if (!confirm(`[${title}] 공지사항을 정말 삭제하시겠습니까?`)) { return; }

            try {
                // 백엔드 API 호출 (권한 체크는 백엔드에서)
                await apiCall(`${SVR_JUNGSI}/jungsi/admin/student-announcements/delete/${noticeId}`, {
                    method: 'DELETE'
                });
                showToast('🗑️ 공지사항이 삭제되었습니다.', true);
                loadAnnouncements();
            } catch (err) {
                 console.error('deleteAnnouncement error caught:', err.message);
            }
        };

        // --- 7. 폼 초기화 함수 ---
        const resetForm = () => {
            const isSean = isSuperAdmin();
            formTitle.textContent = '새 공지사항 작성';
            editingNoticeId.value = '';
            noticeTitle.value = '';
            noticeContent.value = '';
            noticeBranch.value = isSean ? (currentUser?.branch || '') : (currentUser?.branch || '');
            noticeBranch.disabled = !isSean;
            saveNoticeBtn.innerHTML = '<i class="fas fa-save"></i> 저장하기';
            saveNoticeBtn.disabled = false;
            cancelEditBtn.style.display = 'none';
        };

        // --- 이벤트 리스너 연결 ---
        saveNoticeBtn.addEventListener('click', () => {
            if (editingNoticeId.value) {
                saveEditedAnnouncement();
            } else {
                saveNewAnnouncement();
            }
        });
        cancelEditBtn.addEventListener('click', resetForm);

        // --- 초기 실행 ---
        const initializePage = async () => {
            await loadBranchesAndSetupDropdown(); // 1. 지점 목록/상태 설정
            await loadAnnouncements();          // 2. 공지 목록 로드
        };
        initializePage();
    });
</script>

</body>
</html>