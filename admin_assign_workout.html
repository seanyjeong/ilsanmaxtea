<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>데일리 운동 할당 (선생님)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb; --primary-dark:#1d4ed8;
            --light-bg: #f8fafc; --card-bg: #ffffff;
            --border-color: #e2e8f0; --text-primary:#1e293b; --text-secondary:#475569;
            --danger-color: #ef4444; --success-color: #10b981; --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light-bg); padding: 20px; margin: 0; line-height: 1.5; color: var(--text-primary); }
        .container { max-width: 800px; margin: 0 auto; }

        /* ---------- Header & Controls ---------- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            gap: 12px; flex-wrap: wrap;
            background: var(--card-bg); padding: 16px 18px; border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.6rem; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .chip { display: inline-flex; align-items: center; gap: 6px; background: var(--light-bg); padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        .chip label { font-size: .9rem; color: var(--text-secondary); white-space: nowrap; }
        select, input[type="date"] { padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: #fff; font-size: .95rem; min-width: 150px; }
        input[type="date"] { min-width: 0; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: none; border-radius: 8px; font-weight: 600; font-size: .9rem; cursor: pointer; transition: .2s; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; }

        /* ---------- Card ---------- */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
        .card-title { font-size: 1.3rem; font-weight: 600; margin: 0 0 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        
        /* ---------- Assignment Area ---------- */
        .assignment-area { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) {
            .assignment-area { grid-template-columns: 300px 1fr; } /* PC: 좌측 운동 선택, 우측 할당 목록 */
        }
        
        /* 운동 선택 (좌측) */
        .exercise-selector h4 { margin: 0 0 10px; font-size: 1rem; }
        #masterExerciseSelect { width: 100%; font-size: 1rem; padding: 10px; }
        #addExerciseBtn { width: 100%; margin-top: 10px; justify-content: center; }

        /* 할당 목록 (우측) */
        #assignmentList { list-style: none; padding: 0; margin: 0; }
        .assignment-item {
            background: #f8fafc; border: 1px solid var(--border-color);
            border-radius: 8px; padding: 12px; margin-bottom: 10px;
            display: grid; grid-template-columns: 1fr auto; /* 내용 | 삭제버튼 */
            gap: 10px 15px;
        }
        .assignment-item h5 { margin: 0; font-size: 1rem; grid-column: 1 / 2; }
        .assignment-item h5 .category { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; margin-left: 8px; }
        /* ⭐️ 담당 선생님 표시 스타일 */
        .assignment-item h5 .assigning-teacher {
            font-size: 0.8rem; color: var(--text-secondary); display: block;
            margin-top: 4px; font-weight: 500;
        }
        .assignment-item h5 .assigning-teacher.is-self { /* ⭐️ 본인이 할당한 경우 */
            color: var(--primary-color); font-weight: 600;
        }

        .delete-exercise-btn {
            grid-column: 2 / 3; grid-row: 1 / 3; /* 버튼은 2행 차지 */
            background: none; border: none; color: var(--danger-color);
            font-size: 1.2rem; cursor: pointer; padding: 5px;
        }
        .input-grid {
            grid-column: 1 / 2;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px; align-items: center;
        }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 3px; }
        .input-group input {
            width: 100%; padding: 6px 8px; border: 1px solid var(--border-color);
            border-radius: 4px; font-size: .9rem; text-align: center;
        }
        .input-group.notes { grid-column: 1 / -1; } /* 메모칸은 넓게 */
        
        /* 로딩/데이터 없음 */
        .loading, .no-data { text-align: center; padding: 30px; color: var(--text-secondary); }

        /* --- Toast Popup --- */
        .toast-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8); color: white; padding: 10px 18px; border-radius: 20px;
            font-size: 0.9rem; z-index: 1002; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
            pointer-events: none;
        }
        .toast-popup.show { opacity: 1; bottom: 40px; }
        .toast-popup.success { background-color: var(--success-color); }
        .toast-popup.error { background-color: var(--danger-color); }
        
        /* --- ⭐️ 모바일 반응형 ⭐️ --- */
        @media (max-width: 767px) {
            body { padding: 10px; }
            .header { flex-direction: column; align-items: stretch; padding: 15px; }
            .header h1 { font-size: 1.4rem; }
            .header-controls { flex-direction: column; align-items: stretch; }
            .chip { justify-content: space-between; }
            .btn { justify-content: center; }
            .card { padding: 15px; }
            .assignment-area { grid-template-columns: 1fr; } /* 모바일에선 무조건 1열 */
        }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-clipboard-list"></i> 데일리 운동 할당</h1>
        <div class="header-controls">
            <button type="button" id="saveAssignmentsBtn" class="btn btn-primary" disabled>
                <i class="fas fa-save"></i> 학생 운동 할당하기
            </button>
        </div>
    </div>

    <div class="card">
        <div class="header-controls">
            <div class="chip">
                <label for="year-select"><i class="fas fa-calendar-alt"></i> 학년도</label>
                <select id="year-select">
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                </select>
            </div>
             <div class="chip">
                <label for="student-select"><i class="fas fa-user-graduate"></i> 학생</label>
                <select id="student-select">
                    <option value="">- 학년도 선택 -</option>
                </select>
            </div>
             <div class="chip">
                <label for="date-select"><i class="fas fa-calendar-day"></i> 할당 날짜</label>
                <input type="date" id="date-select">
            </div>
        </div>
    </div>
    
    <div class="assignment-area">
        <div class="card">
            <h4 class="card-title">1. 운동 선택</h4>
            <select id="masterExerciseSelect">
                <option value="">- 운동 목록 로딩 중 -</option>
            </select>
            <button type="button" id="addExerciseBtn" class="btn btn-primary" disabled>
                <i class="fas fa-plus"></i> 목록에 추가
            </button>
        </div>
        
        <div class="card">
            <h4 class="card-title">2. 오늘 할당할 운동 (5개이하)
                
            </h4>
            
            <ul id="assignmentList">
                <p class="no-data" id="assignmentListPlaceholder">학생과 날짜를 선택하세요.</p>
                </ul>
        </div>
    </div>
</div>

<template id="assignmentItemTemplate">
    <li class="assignment-item" data-exercise-id="{{exercise_id}}" data-assignment-id="{{assignment_id}}"> 
        <h5>
            <span class="exercise-name">운동명</span>
            <span class="category">[카테고리]</span>
            <span class="assigning-teacher"></span>
            </h5>
        <button type="button" class="delete-exercise-btn" onclick="removeExerciseItem(this)" title="삭제">
            <i class="fas fa-times-circle"></i>
        </button>
        <div class="input-grid">
            <div class="input-group">
                <label>무게(kg)</label>
                <input type="number" name="target_weight" placeholder="무게">
            </div>
            <div class="input-group">
                <label>세트</label>
                <input type="number" name="target_sets" placeholder="세트">
            </div>
            <div class="input-group">
                <label>횟수</label>
                <input type="number" name="target_reps" placeholder="횟수">
            </div>
            <div class="input-group notes">
                <label>추가 메모 (목표 기록 등)</label>
                <input type="text" name="target_notes" placeholder="예: 8.0초 목표, 자세 집중">
            </div>
        </div>
    </li>
</template>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 서버 및 인증 ---
        const SVR_JUNGSI = 'https://supermax.kr';
        const LOGIN_PAGE = 'admin_login.html'; // ⭐️ 로그인 페이지 경로 확인

        // --- HTML 요소 ---
        const yearSelect = document.getElementById('year-select');
        const studentSelect = document.getElementById('student-select');
        const dateSelect = document.getElementById('date-select');
        const masterExerciseSelect = document.getElementById('masterExerciseSelect');
        const addExerciseBtn = document.getElementById('addExerciseBtn');
        const assignmentList = document.getElementById('assignmentList');
        const assignmentListPlaceholder = document.getElementById('assignmentListPlaceholder');
        const saveAssignmentsBtn = document.getElementById('saveAssignmentsBtn');
        const assignmentItemTemplate = document.getElementById('assignmentItemTemplate'); // ⭐️ 템플릿 가져오기

        let currentStudentList = []; // ⭐️ 학생 목록 저장용 (이름 변경)
        let masterExercises = [];
        let currentUser = null;
        let isManagement = false; // ⭐️ 관리 권한 여부

        // --- 인증 확인 및 권한 설정 ---
        const getToken = () => localStorage.getItem('jwt_token');
        const token = getToken();
        if (!token) { alert('로그인이 필요합니다.'); window.location.href = LOGIN_PAGE; return; }
        try {
            const payloadBase64Url = token.split('.')[1];
            const payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
            const decodedString = new TextDecoder().decode(Uint8Array.from(atob(payloadBase64), c => c.charCodeAt(0)));
            currentUser = JSON.parse(decodedString);
            console.log("로그인 사용자:", currentUser);
            // ⭐️ 관리 권한 확인 (직급 또는 admin 역할)
            isManagement = currentUser && (
                (currentUser.position && ['원장', '부원장', '팀장'].includes(currentUser.position)) ||
                currentUser.role === 'admin'
            );
            console.log("관리 권한 여부:", isManagement);
        } catch (e) {
            console.error('토큰 처리 실패:', e); alert('인증 정보 오류.'); window.location.href = LOGIN_PAGE; return;
        }

        // --- API 호출 함수 (인증 포함) ---
        const apiCall = async (url, options = {}) => {
            const currentToken = getToken();
            if (!currentToken) { alert('로그인 세션 만료'); window.location.href = LOGIN_PAGE; throw new Error('로그인 만료'); }
            options.headers = { ...options.headers, 'Authorization': `Bearer ${currentToken}` };
            try {
                const response = await fetch(url, options);
                if (response.status === 401) { // ⭐️ 401 Unauthorized
                     alert('로그인 세션이 만료되었습니다. 다시 로그인해주세요.');
                     localStorage.removeItem('jwt_token'); window.location.href = LOGIN_PAGE; throw new Error('로그인 만료');
                } else if (response.status === 403) { // ⭐️ 403 Forbidden
                     alert('인증 오류 또는 권한이 없습니다.');
                     // 로그인 페이지로 강제 이동 대신 에러만 throw
                     throw new Error('권한 없음');
                }
                if (!response.ok) {
                    let errorMsg = `HTTP 오류 ${response.status}`; try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch (_) {} throw new Error(errorMsg);
                }
                if (response.status === 204) { return { success: true }; }
                return await response.json();
            } catch (error) {
                console.error('API 호출 실패:', url, error);
                if (error.message !== '로그인 만료' && error.message !== '권한 없음') {
                    // ⭐️ 네트워크 오류 등만 토스트로 표시
                    showToast(`네트워크 또는 서버 오류: ${error.message}`, false);
                    throw new Error(error.message || '네트워크 오류');
                }
                throw error; // '로그인 만료' 또는 '권한 없음'은 그대로 throw
            }
        };

        // --- Toast Popup 함수 ---
        const showToast = (message, isSuccess = true) => { const el = document.createElement('div'); el.textContent = message; el.className = `toast-popup ${isSuccess ? 'success' : 'error'}`; document.body.appendChild(el); setTimeout(() => el.classList.add('show'), 10); setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 2500); };
        
        // --- 오늘 날짜 설정 ---
        const setTodayDate = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateSelect.value = `${year}-${month}-${day}`;
        };

        // --- 1. 학생 목록 로드 (관리자/일반 분기 적용됨) ---
        const loadStudentList = async () => { // ⭐️ 이름 변경: loadMyStudents -> loadStudentList
            const selectedYear = yearSelect.value;
            studentSelect.innerHTML = '<option value="">- 학생 로딩 중 -</option>';
            studentSelect.disabled = true;
            try {
                // ⭐️ 백엔드 API가 역할(직급)에 따라 다른 목록을 줌
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/teacher/my-students?year=${selectedYear}`);
                if (data.success && data.students) {
                    currentStudentList = data.students; // ⭐️ 변수명 변경
                    studentSelect.innerHTML = '<option value="">- 학생 선택 -</option>';
                    currentStudentList.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.account_id;
                        // ⭐️ 반 배정 안 된 학생도 이름이 보이도록 수정
                        option.textContent = `${student.student_name} (${student.class_name || '반 미배정'})`;
                        studentSelect.appendChild(option);
                    });
                    studentSelect.disabled = false;
                } else {
                    studentSelect.innerHTML = '<option value="">- 학생 없음 -</option>';
                }
            } catch (err) {
                console.error('학생 목록 로딩 오류:', err);
                if (err.message !== '권한 없음' && err.message !== '로그인 만료') {
                    studentSelect.innerHTML = '<option value="">- 로드 오류 -</option>';
                    showToast(`학생 목록 로드 오류: ${err.message}`, false);
                }
            }
            // ⭐️ 학생 목록 로드 후, 기존 운동 목록 비우기
            clearAssignmentList();
            checkSaveButtonStatus();
        };
        
        // --- 2. 운동 마스터 목록 로드 ---
        const loadMasterExercises = async () => {
            masterExerciseSelect.disabled = true;
            try {
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/master-exercises`);
                if (data.success && data.exercises) {
                    masterExercises = data.exercises;
                    masterExerciseSelect.innerHTML = '<option value="">- 운동 선택 -</option>';
                    const categories = {};
                    masterExercises.forEach(ex => {
                        if (!categories[ex.category]) categories[ex.category] = [];
                        categories[ex.category].push(ex);
                    });
                    const categoryOrder = ['Skill', 'Weight', 'Other'];
                    categoryOrder.forEach(categoryName => {
                        if (categories[categoryName]) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = `--- ${categoryName} ---`;
                            categories[categoryName].forEach(ex => {
                                const option = document.createElement('option');
                                option.value = ex.exercise_id;
                                option.textContent = `${ex.exercise_name} (${ex.sub_category || '기타'})`;
                                option.dataset.exercise = JSON.stringify(ex);
                                optgroup.appendChild(option);
                            });
                            masterExerciseSelect.appendChild(optgroup);
                        }
                    });
                    masterExerciseSelect.disabled = false;
                    addExerciseBtn.disabled = false;
                } else { /* ... (기존 에러 처리) ... */ }
            } catch (err) { /* ... (기존 에러 처리) ... */ }
        };

        // --- ⭐️ 3. 특정 학생/날짜의 할당된 운동 목록 로드 및 렌더링 ---
        const loadAssignmentsForStudent = async () => {
            const studentId = studentSelect.value;
            const assignmentDate = dateSelect.value;

            if (!studentId || !assignmentDate) {
                clearAssignmentList('<p class="no-data" id="assignmentListPlaceholder">학생과 날짜를 선택하세요.</p>');
                checkSaveButtonStatus();
                return;
            }

            console.log(`Loading assignments for student ${studentId} on ${assignmentDate}`);
            assignmentList.innerHTML = `<p class="loading"><i class="fas fa-spinner fa-spin"></i> ${assignmentDate} 운동 목록 로딩 중...</p>`;
            saveAssignmentsBtn.disabled = true; // 로딩 중 저장 비활성화

            try {
                // ⭐️ 새 백엔드 API 호출
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/teacher/assignments/${studentId}/${assignmentDate}`);
                if (data.success && data.assignments) {
                    renderAssignmentList(data.assignments); // 렌더링 함수 호출
                } else {
                     clearAssignmentList(`<p class="no-data">운동 목록 로드 실패: ${data.message || '오류'}</p>`);
                }
            } catch (err) {
                 console.error('loadAssignmentsForStudent error:', err);
                 if (err.message !== '로그인 만료' && err.message !== '권한 없음') {
                    clearAssignmentList(`<p class="no-data">오류 발생: ${err.message}</p>`);
                 }
            } finally {
                 checkSaveButtonStatus(); // 로딩 후 저장 버튼 상태 재확인
            }
        };

        // --- ⭐️ 3-1. 할당된 운동 목록 렌더링 함수 ---
        const renderAssignmentList = (assignments) => {
            assignmentList.innerHTML = ''; // 기존 내용 비우기
            if (assignments.length === 0) {
                assignmentList.innerHTML = '<p class="no-data" id="assignmentListPlaceholder">할당된 운동이 없습니다. 새로 추가하세요.</p>';
                return;
            }
            assignments.forEach(item => {
                const newItem = createAssignmentItemElement(item); // 항목 생성 함수 호출
                assignmentList.appendChild(newItem);
            });
        };

       // --- ⭐️ 3-2. 개별 운동 항목 Element 생성 함수 ---
       const createAssignmentItemElement = (itemData) => {
           // itemData: { assignment_id, exercise_name, category, sub_category, target_weight, ..., teacher_userid, teacher_name }
           const template = assignmentItemTemplate;
           const newItem = template.content.cloneNode(true).firstElementChild;

           // 마스터 목록에서 exercise_id 찾기 (이름 기준)
           const masterExercise = masterExercises.find(ex => ex.exercise_name === itemData.exercise_name);
           const exerciseId = masterExercise ? masterExercise.exercise_id : null;

           newItem.dataset.exerciseId = exerciseId || ''; // 마스터 ID
           newItem.dataset.assignmentId = itemData.assignment_id || ''; // DB 할당 ID
           newItem.querySelector('.exercise-name').textContent = itemData.exercise_name;
           newItem.querySelector('.category').textContent = `[${itemData.category || '?'} / ${itemData.sub_category || '기타'}]`;

           // 담당 선생님 이름 표시
           const teacherNameSpan = newItem.querySelector('.assigning-teacher');
           const teacherName = itemData.teacher_name; // API에서 받은 이름
           const teacherId = itemData.teacher_userid;
           let teacherDisplayText = '할당: 알수없음';
           if (teacherName) {
               teacherDisplayText = `할당: ${teacherName} 선생님`;
           } else if (teacherId) {
               teacherDisplayText = `할당: ${teacherId} 선생님`;
           }
           teacherNameSpan.textContent = teacherDisplayText;
           // ⭐️ 본인이 할당한 항목인지 체크
           if (teacherId === currentUser.userid) {
               teacherNameSpan.classList.add('is-self');
               teacherNameSpan.textContent = `(내가 할당) ${teacherDisplayText}`;
           }

           // 입력칸 값 채우기
           newItem.querySelector('input[name="target_weight"]').value = itemData.target_weight || '';
           newItem.querySelector('input[name="target_sets"]').value = itemData.target_sets || '';
           newItem.querySelector('input[name="target_reps"]').value = itemData.target_reps || '';
           newItem.querySelector('input[name="target_notes"]').value = itemData.target_notes || '';

           // 운동 유형에 따라 입력칸 비활성화
           if (itemData.category !== 'Weight') {
                const weightInput = newItem.querySelector('input[name="target_weight"]');
                if (weightInput) { weightInput.disabled = true; weightInput.placeholder = '-'; }
           }
           // ⭐️ 본인이 할당한 항목이 아니면 삭제 버튼 비활성화 (선택 사항)
           // if (teacherId !== currentUser.userid) {
           //     const deleteBtn = newItem.querySelector('.delete-exercise-btn');
           //     if(deleteBtn) deleteBtn.style.display = 'none';
           // }
           
           // ⭐️ 본인이 할당한 항목이 아니면 입력칸 비활성화 (선택 사항)
           if (teacherId !== currentUser.userid) {
                newItem.querySelectorAll('input').forEach(input => input.disabled = true);
                newItem.querySelector('.delete-exercise-btn')?.remove(); // 삭제 버튼 아예 제거
           }

           return newItem;
       };

        // --- 4. 할당 목록에 새 운동 추가 ---
        const addExerciseToList = () => {
            const selectedOption = masterExerciseSelect.options[masterExerciseSelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) { showToast('추가할 운동을 선택하세요.', false); return; }
            const exerciseData = JSON.parse(selectedOption.dataset.exercise);
            if (assignmentList.querySelector(`li[data-exercise-id="${exerciseData.exercise_id}"]`)) { showToast('이미 목록에 추가된 운동입니다.', false); return; }

            // ⭐️ createAssignmentItemElement 함수 재활용
            const newItemData = {
                assignment_id: null,
                exercise_name: exerciseData.exercise_name,
                category: exerciseData.category,
                sub_category: exerciseData.sub_category,
                // 기본값 null
                teacher_userid: currentUser.userid, // ⭐️ 현재 로그인한 사용자 ID
                teacher_name: currentUser.name // ⭐️ 현재 로그인한 사용자 이름
            };
            const newItemElement = createAssignmentItemElement(newItemData);
            
            // ⭐️ (내가 할당) 표시는 createAssignmentItemElement에서 자동으로 처리됨

            const placeholder = document.getElementById('assignmentListPlaceholder');
            if (placeholder) placeholder.style.display = 'none';

            assignmentList.appendChild(newItemElement);
            masterExerciseSelect.value = '';
            checkSaveButtonStatus();
        };

        // --- 5. 할당 목록에서 운동 제거 ---
        window.removeExerciseItem = (buttonElement) => {
            const item = buttonElement.closest('.assignment-item');
            // ⭐️ 본인이 할당한 항목만 삭제 가능 (createAssignmentItemElement에서 버튼이 제거되므로 사실상 필요 없는 체크)
            // if (item.querySelector('.assigning-teacher.is-self')) {
                item.remove();
                checkSaveButtonStatus(); // 버튼 상태 확인
            // } else {
            //     showToast('본인이 할당한 항목만 삭제할 수 있습니다.', false);
            // }
            
            // ⭐️ 플레이스홀더 표시 로직 수정
            const placeholder = document.getElementById('assignmentListPlaceholder');
            // li.assignment-item이 하나도 없으면
            if (assignmentList.querySelectorAll('li.assignment-item').length === 0) {
                 if (placeholder) {
                     placeholder.style.display = 'block';
                 } else {
                     // 플레이스홀더가 아예 없는 경우 대비
                     assignmentList.innerHTML = '<p class="no-data" id="assignmentListPlaceholder">운동을 추가하세요.</p>';
                 }
            }
        };
        
        // --- 6. 저장 버튼 활성화/비활성화 체크 ---
        const checkSaveButtonStatus = () => {
            const studentId = studentSelect.value;
            const assignmentDate = dateSelect.value;
            // ⭐️ 학생과 날짜가 선택되었으면 항상 활성화 (빈 목록 저장 = 삭제 기능)
            saveAssignmentsBtn.disabled = !(studentId && assignmentDate);
        };

        // --- 7. 최종 할당 저장 함수 (백엔드는 Delete then Insert) ---
        const saveAssignments = async () => {
            const studentId = studentSelect.value;
            const assignmentDate = dateSelect.value;
            if (!studentId || !assignmentDate) { showToast('학생과 할당 날짜를 모두 선택해야 합니다.', false); return; }

            saveAssignmentsBtn.disabled = true;
            saveAssignmentsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 저장 중...';

            const assignments = [];
            // ⭐️ 현재 목록에서 *내가 할당한 항목만* 수집
            assignmentList.querySelectorAll('li.assignment-item').forEach(item => {
                // ⭐️ 본인이 할당한 항목인지 확인 (is-self 클래스 또는 data-assignment-id가 비어있는지)
                const isMine = item.querySelector('.assigning-teacher.is-self') || !item.dataset.assignmentId;
                
                if (!isMine) {
                    console.log('Skipping save (not mine):', item.querySelector('.exercise-name').textContent);
                    return; // 내가 할당한 항목이 아니면 저장 목록에서 제외
                }

                const exerciseId = item.dataset.exerciseId;
                const exerciseData = masterExercises.find(ex => ex.exercise_id == exerciseId || ex.exercise_name === item.querySelector('.exercise-name').textContent);
                
                if (!exerciseData) {
                     console.warn("저장 실패: 마스터 운동 정보를 찾을 수 없음:", item.querySelector('.exercise-name').textContent);
                     return;
                 }

                assignments.push({
                    exercise_name: exerciseData.exercise_name,
                    category: exerciseData.category,
                    sub_category: exerciseData.sub_category || null,
                    target_weight: item.querySelector('input[name="target_weight"]').value || null,
                    target_sets: item.querySelector('input[name="target_sets"]').value || null,
                    target_reps: item.querySelector('input[name="target_reps"]').value || null,
                    target_notes: item.querySelector('input[name="target_notes"]').value || null,
                });
            });

            console.log('Saving assignments (mine only):', assignments);

            try {
                // ⭐️ 백엔드 API 호출: /jungsi/teacher/assign-workout
                //    (백엔드 로직: studentId, date, teacherId 기준으로 기존 것 삭제 후, assignments 배열 삽입)
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/teacher/assign-workout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_account_id: parseInt(studentId),
                        assignment_date: assignmentDate,
                        assignments: assignments // ⭐️ 내가 할당한 운동 목록만 전송
                    })
                });
                if (data.success) {
                    showToast('✅ 학생의 데일리 운동이 저장되었습니다.', true);
                    // ⭐️ 저장 성공 후, 목록을 다시 불러와서 다른 선생님이 할당한 것도 포함하여 최신 상태 표시
                    loadAssignmentsForStudent();
                }
                // 실패 시 apiCall에서 처리
            } catch (err) {
                console.error('운동 할당 저장 오류:', err);
                if (err.message !== '로그인 만료' && err.message !== '인증 오류') {
                    showToast(`❌ 저장 중 오류 발생: ${err.message}`, false);
                }
            } finally {
                saveAssignmentsBtn.disabled = false;
                saveAssignmentsBtn.innerHTML = '<i class="fas fa-save"></i> 학생 운동 할당하기';
            }
        };

        // --- 8. 운동 목록 비우기 함수 ---
        const clearAssignmentList = (messageHtml = '<p class="no-data" id="assignmentListPlaceholder">학생과 날짜를 선택하세요.</p>') => {
            assignmentList.innerHTML = messageHtml;
        };

        // --- 이벤트 리스너 연결 ---
        yearSelect.addEventListener('change', loadStudentList); // ⭐️ 학생 목록 다시 로드
        studentSelect.addEventListener('change', loadAssignmentsForStudent); // ⭐️ 선택된 학생의 운동 로드
        dateSelect.addEventListener('change', loadAssignmentsForStudent); // ⭐️ 선택된 날짜의 운동 로드
        addExerciseBtn.addEventListener('click', addExerciseToList);
        saveAssignmentsBtn.addEventListener('click', saveAssignments);

        // --- 7. 초기 실행 ---
        setTodayDate();
        loadStudentList(); // 학생 목록 먼저 로드
        loadMasterExercises(); // 운동 마스터 로드

    });
</script>

</body>
</html>