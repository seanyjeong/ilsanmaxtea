<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>데일리 운동 할당 (선생님)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb; --primary-dark:#1d4ed8;
            --light-bg: #f8fafc; --card-bg: #ffffff;
            --border-color: #e2e8f0; --text-primary:#1e293b; --text-secondary:#475569;
            --danger-color: #ef4444; --success-color: #10b981; --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light-bg); padding: 20px; margin: 0; line-height: 1.5; color: var(--text-primary); }
        .container { max-width: 800px; margin: 0 auto; }

        /* ---------- Header & Controls ---------- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            gap: 12px; flex-wrap: wrap;
            background: var(--card-bg); padding: 16px 18px; border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.6rem; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .chip { display: inline-flex; align-items: center; gap: 6px; background: var(--light-bg); padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        .chip label { font-size: .9rem; color: var(--text-secondary); white-space: nowrap; }
        select, input[type="date"] { padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: #fff; font-size: .95rem; min-width: 150px; }
        input[type="date"] { min-width: 0; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: none; border-radius: 8px; font-weight: 600; font-size: .9rem; cursor: pointer; transition: .2s; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; }

        /* ⭐️ [신규] 학생 다중 선택 UI */
        .student-selector-wrapper { position: relative; min-width: 200px; }
        .student-selector-button {
            padding: 8px 10px; border: 1px solid var(--border-color);
            border-radius: 6px; background: #fff; font-size: .95rem;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            min-width: 200px;
        }
        .student-selector-button:hover { background: var(--light-bg); }
        .student-dropdown {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: #fff; border: 1px solid var(--border-color);
            border-radius: 6px; box-shadow: var(--shadow);
            max-height: 300px; overflow-y: auto; z-index: 100;
            margin-top: 4px;
        }
        .student-dropdown.show { display: block; }
        .student-dropdown-item {
            padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .student-dropdown-item:last-child { border-bottom: none; }
        .student-dropdown-item:hover { background: var(--light-bg); }
        .student-dropdown-item input[type="checkbox"] { cursor: pointer; }
        .student-dropdown-header {
            padding: 8px 12px; background: var(--light-bg); font-weight: 600;
            font-size: 0.85rem; color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .select-all-btn {
            font-size: 0.8rem; color: var(--primary-color); cursor: pointer;
            padding: 2px 6px; border-radius: 4px;
        }
        .select-all-btn:hover { background: var(--primary-color); color: #fff; }
        .selected-count {
            background: var(--primary-color); color: #fff;
            padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;
            margin-left: 6px;
        }
        
        /* ⭐️ [수정] .btn-secondary 기본 스타일 (전날 불러오기 버튼용) */
        .btn-secondary {
            background: var(--light-bg); color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover:not(:disabled) { background: var(--border-color); }
        .btn-secondary:disabled { background: #f1f5f9; color: #9ca3af; cursor: not-allowed; opacity: 0.7; }

        .header-controls .btn-secondary {
            font-size: 0.8rem; padding: 8px 10px;
        }

        /* ---------- Card ---------- */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
        .card-title { font-size: 1.3rem; font-weight: 600; margin: 0; padding: 0; border: none; }
        
        .card-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* ⭐️ 모바일에서 줄바꿈 허용 */
            gap: 10px; /* ⭐️ 버튼 사이 간격 */
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .card-header-flex .btn {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        /* ---------- Assignment Area ---------- */
        .assignment-area { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) {
            .assignment-area { 
                grid-template-columns: 300px 1fr; 
                align-items: start; /* ⭐️ (신규) 상단 정렬 */
            } 
        }
        
        /* ⭐️ (신규) 운동 선택 영역 스크롤 처리 */
        .selector-container {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* 운동 선택 (좌측) - 버튼 UI */
        .selector-container label {
            font-size: 0.8rem; font-weight: 600; color: var(--text-secondary);
            margin: 10px 0 5px; display: block;
        }
        .selector-container label:first-child { margin-top: 0; }
        .selector-group {
            display: flex; flex-wrap: wrap; gap: 8px;
            padding: 10px; background: #f8fafc; border: 1px solid var(--border-color);
            border-radius: 8px; min-height: 40px;
        }
        .selector-group .loading-text, .selector-group .placeholder-text {
            font-size: 0.9rem; color: var(--text-secondary); align-self: center;
        }
        .select-btn {
            padding: 8px 12px; font-size: 0.9rem; font-weight: 500;
            border: 1px solid var(--border-color); background: #fff; color: var(--text-primary);
            border-radius: 6px; cursor: pointer; transition: all 0.2s;
        }
        .select-btn:hover {
            background: var(--primary-color); color: #fff; border-color: var(--primary-color);
        }
        .select-btn.active {
            background: var(--primary-dark); color: #fff; border-color: var(--primary-dark);
            font-weight: 600;
        }
        .add-exercise-btn {
            background: #fff; color: var(--primary-color); border: 1px solid var(--primary-color);
        }
        .add-exercise-btn:hover { background: var(--primary-color); color: #fff; }


        /* 할당 목록 (우측) */
        #assignmentList { list-style: none; padding: 0; margin: 0; }
        .assignment-item {
            background: #f8fafc; border: 1px solid var(--border-color);
            border-radius: 8px; padding: 12px; margin-bottom: 10px;
            display: grid; grid-template-columns: 1fr auto;
            gap: 10px 15px;
        }
        .assignment-item h5 { margin: 0; font-size: 1rem; grid-column: 1 / 2; }
        .assignment-item h5 .category { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; margin-left: 8px; }
        .delete-exercise-btn {
            grid-column: 2 / 3; grid-row: 1 / 3;
            background: none; border: none; color: var(--danger-color);
            font-size: 1.2rem; cursor: pointer; padding: 5px;
        }
        .delete-exercise-btn:disabled {
            color: #9ca3af; cursor: not-allowed; opacity: 0.5;
        }
        .delete-exercise-btn[data-is-completed="true"] {
            color: #9ca3af; cursor: not-allowed; opacity: 0.5;
        }
        .input-grid {
            grid-column: 1 / 2;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px; align-items: center;
        }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 3px; }
        .input-group input {
            width: 100%; padding: 6px 8px; border: 1px solid var(--border-color);
            border-radius: 4px; font-size: .9rem; text-align: center;
        }
        .input-group.notes { grid-column: 1 / -1; }
        
        /* 로딩/데이터 없음 */
        .loading, .no-data { text-align: center; padding: 30px; color: var(--text-secondary); }

        /* --- Toast Popup --- */
        .toast-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8); color: white; padding: 10px 18px; border-radius: 20px;
            font-size: 0.9rem; z-index: 1002; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
            pointer-events: none;
        }
        .toast-popup.show { opacity: 1; bottom: 40px; }
        .toast-popup.success { background-color: var(--success-color); }
        .toast-popup.error { background-color: var(--danger-color); }
        
        /* --- 모바일 반응형 --- */
        @media (max-width: 767px) {
            body { padding: 10px; }
            .header { flex-direction: column; align-items: stretch; padding: 15px; }
            .header h1 { font-size: 1.4rem; }
            .header-controls { flex-direction: column; align-items: stretch; }
            .chip { justify-content: space-between; }
            .btn { justify-content: center; }
            .card { padding: 15px; }
            .assignment-area { grid-template-columns: 1fr; }
            
            /* ⭐️ (신규) 모바일에서 스크롤 높이 제한 */
            .selector-container {
                max-height: 40vh;
            }

            .card-header-flex .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-clipboard-list"></i> 일일퀘스트 할당</h1>
        <div class="header-controls">
            <a href="admin_manage_exercises.html" class="btn btn-secondary">
                <i class="fas fa-cog"></i> 퀘스트 목록 관리
            </a>
        </div>
    </div>

    <div class="card">
        <div class="header-controls" style="flex-wrap: wrap; justify-content: space-between;">
            <div class="chip">
                <label for="year-select"><i class="fas fa-calendar-alt"></i> 학년도</label>
                <select id="year-select">
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                </select>
            </div>
             <div class="chip">
                <label><i class="fas fa-user-graduate"></i> 학생</label>
                <div class="student-selector-wrapper">
                    <div class="student-selector-button" id="studentSelectorButton">
                        <span id="studentSelectorText">- 학년도 선택 -</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="student-dropdown" id="studentDropdown">
                        <div class="student-dropdown-header">
                            <span>학생 선택</span>
                            <span class="select-all-btn" id="selectAllBtn">전체 선택</span>
                        </div>
                        <div id="studentDropdownList">
                            <!-- 학생 목록이 여기에 동적으로 추가됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
             <div class="chip">
                <label for="date-select"><i class="fas fa-calendar-day"></i> 할당 날짜</label>
                <input type="date" id="date-select">
            </div>
            <button type="button" id="loadPrevDayBtn" class="btn btn-secondary" style="padding: 8px 12px; font-size: 0.9rem; flex-grow: 1; min-width: 150px;" disabled>
                <i class="fas fa-history"></i> 전날 운동 불러오기
            </button>
            </div>
    </div>
    
    <div class="assignment-area">
        <div class="card">
            <h4 class="card-title">1. 퀘스트 선택</h4>
            <div class="selector-container"> <label>1. 카테고리</label>
                <div id="categorySelector" class="selector-group">
                    <p class="loading-text">퀘스트 목록 로딩 중...</p>
                </div>
                <label>2. 세부 카테고리</label>
                <div id="subCategorySelector" class="selector-group" style="display: none;">
                    <p class="placeholder-text">카테고리를 먼저 선택하세요.</p>
                </div>
                <label>3. 운동</label>
                <div id="exerciseButtonContainer" class="selector-group" style="display: none;">
                    <p class="placeholder-text">세부 카테고리를 선택하세요.</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header-flex">
                <h4 class="card-title">2. 퀘스트 내용</h4>
                <button type="button" id="clearAssignmentsBtn" class="btn" style="background-color: var(--warning-color); color: white;">
                    <i class="fas fa-times-circle"></i> 목록 초기화(초기화후, 수정버튼 눌러야함)
                </button>
                <button type="button" id="saveAssignmentsBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-save"></i> 일일 퀘스트 할당 및 수정
                </button>
            </div>
            
            <ul id="assignmentList">
                <p class="no-data" id="assignmentListPlaceholder">퀘스트를 추가하세요.</p>
            </ul>
        </div>
    </div>
</div>

<template id="assignmentItemTemplate">
    <li class="assignment-item" data-exercise-id="{{exercise_id}}">
        <h5>
            <span class="exercise-name">운동명</span>
            <span class="category">[카테고리]</span>
        </h5>
        <button type="button" class="delete-exercise-btn" onclick="removeExerciseItem(this)" title="삭제">
            <i class="fas fa-times-circle"></i>
        </button>
        <div class="input-grid">
            <div class="input-group">
                <label>무게(kg)</label>
                <input type="number" name="target_weight" placeholder="무게">
            </div>
            <div class="input-group">
                <label>세트</label>
                <input type="number" name="target_sets" placeholder="세트">
            </div>
            <div class="input-group">
                <label>횟수</label>
                <input type="number" name="target_reps" placeholder="횟수">
            </div>
            <div class="input-group notes">
                <grid-column: 1 / -1;>
                <label>추가 메모 (목표 기록 등)</label>
                <input type="text" name="target_notes" placeholder="예: 8.0초 목표, 자세 집중">
            </div>
        </div>
    </li>
</template>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 서버 및 인증 ---
        const SVR_JUNGSI = 'https://supermax.kr';
        const LOGIN_PAGE = 'admin_login.html'; //

        // --- HTML 요소 ---
        const yearSelect = document.getElementById('year-select');
        const studentSelectorButton = document.getElementById('studentSelectorButton');
        const studentSelectorText = document.getElementById('studentSelectorText');
        const studentDropdown = document.getElementById('studentDropdown');
        const studentDropdownList = document.getElementById('studentDropdownList');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const dateSelect = document.getElementById('date-select');
        const categorySelector = document.getElementById('categorySelector');
        const subCategorySelector = document.getElementById('subCategorySelector');
        const exerciseButtonContainer = document.getElementById('exerciseButtonContainer');
        const assignmentList = document.getElementById('assignmentList');
        const assignmentListPlaceholder = document.getElementById('assignmentListPlaceholder');
        const saveAssignmentsBtn = document.getElementById('saveAssignmentsBtn');
        const loadPrevDayBtn = document.getElementById('loadPrevDayBtn'); // ⭐️ [신규]
        const clearAssignmentsBtn = document.getElementById('clearAssignmentsBtn'); // ⭐️ [신규]

        let myStudents = [];
        let selectedStudentIds = []; // ⭐️ [신규] 선택된 학생 ID 목록
        let masterExercises = [];
        let groupedExercises = {};

        // --- 인증 확인 ---
        const getToken = () => localStorage.getItem('jwt_token');
        // ... (인증 로직은 기존과 동일) ...
        const token = getToken();
        let currentUser = null;
        if (!token) { alert('로그인이 필요합니다.'); window.location.href = LOGIN_PAGE; return; }
        try {
            const payloadBase64Url = token.split('.')[1];
            const payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
            const decodedString = new TextDecoder().decode(Uint8Array.from(atob(payloadBase64), c => c.charCodeAt(0)));
            currentUser = JSON.parse(decodedString);
            console.log("로그인 사용자:", currentUser);
        } catch (e) {
            console.error('토큰 처리 실패:', e); alert('인증 정보 오류.'); window.location.href = LOGIN_PAGE; return;
        }

        // --- API 호출 함수 (인증 포함) ---
        const apiCall = async (url, options = {}) => {
            // ... (기존과 동일) ...
            const currentToken = getToken();
            if (!currentToken) { alert('로그인 세션 만료'); window.location.href = LOGIN_PAGE; throw new Error('로그인 만료'); }
            options.headers = { ...options.headers, 'Authorization': `Bearer ${currentToken}` };
            try {
                const response = await fetch(url, options);
                if (response.status === 401 || response.status === 403) {
                     alert('인증 오류 또는 권한 없음'); localStorage.removeItem('jwt_token'); window.location.href = LOGIN_PAGE; throw new Error('인증 오류');
                }
                if (!response.ok) {
                    let errorMsg = `HTTP 오류 ${response.status}`; try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch (_) {} throw new Error(errorMsg);
                }
                if (response.status === 204) { return { success: true }; }
                return await response.json();
            } catch (error) {
                console.error('API 호출 실패:', url, error);
                if (error.message !== '로그인 만료' && error.message !== '인증 오류') { 
                    showToast(`네트워크 또는 서버 오류: ${error.message}`, false); // ⭐️ (수정) 토스트 추가
                    throw new Error(error.message || '네트워크 오류'); 
                } throw error;
            }
        };

        // --- Toast Popup 함수 ---
const showToast = (message, isSuccess = true, duration = 3000) => { // ⭐️ duration 파라미터 추가
            const el = document.createElement('div'); 
            el.textContent = message; 
            el.className = `toast-popup ${isSuccess ? 'success' : 'error'}`; 
            document.body.appendChild(el); 
            setTimeout(() => el.classList.add('show'), 10); 
            setTimeout(() => { 
                el.classList.remove('show'); 
                setTimeout(() => el.remove(), 500); 
            }, duration); // ⭐️ 3000 -> duration으로 변경
        };
        
        // --- 오늘 날짜 설정 ---
        const setTodayDate = () => {
            // ... (기존과 동일) ...
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateSelect.value = `${year}-${month}-${day}`;
        };

        // --- 1. 내 담당 학생 목록 로드 ---
        const loadMyStudents = async () => {
            const selectedYear = yearSelect.value;
            studentSelectorText.textContent = '- 학생 로딩 중 -';
            studentDropdownList.innerHTML = '';
            selectedStudentIds = [];

            renderAssignmentListPlaceholder('학생을 선택하면 퀘스트 내용을 볼 수 있습니다.');
            checkSaveButtonStatus(); // ⭐️ 버튼 상태 갱신

            try {
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/teacher/my-students?year=${selectedYear}`);
                if (data.success && data.students) {
                    myStudents = data.students;

                    if (myStudents.length === 0) {
                        studentSelectorText.textContent = '- 학생 없음 -';
                        return;
                    }

                    // ⭐️ [신규] 체크박스 목록 생성
                    studentDropdownList.innerHTML = '';
                    myStudents.forEach(student => {
                        const item = document.createElement('div');
                        item.className = 'student-dropdown-item';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = student.account_id;
                        checkbox.id = `student-${student.account_id}`;
                        checkbox.addEventListener('change', handleStudentSelectionChange);

                        const label = document.createElement('label');
                        label.htmlFor = `student-${student.account_id}`;
                        label.textContent = `${student.student_name} (${student.class_name || '반 미배정'})`;
                        label.style.cursor = 'pointer';
                        label.style.flex = '1';

                        item.appendChild(checkbox);
                        item.appendChild(label);
                        studentDropdownList.appendChild(item);
                    });

                    studentSelectorText.textContent = '- 학생 선택 -';
                } else {
                    studentSelectorText.textContent = '- 학생 없음 -';
                }
            } catch (err) {
                console.error('담당 학생 목록 로딩 오류:', err);
                studentSelectorText.textContent = '- 로드 오류 -';
            }
        };
        
        // --- ⭐️ [신규] 1-1. 학생 선택 관련 함수들 ---
        const handleStudentSelectionChange = () => {
            // 체크된 학생 ID 목록 업데이트
            const checkboxes = studentDropdownList.querySelectorAll('input[type="checkbox"]:checked');
            selectedStudentIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            // 버튼 텍스트 업데이트
            updateStudentSelectorText();

            // 기존 할당 내역 로드 (단일 학생 선택 시에만)
            if (selectedStudentIds.length === 1) {
                loadExistingAssignments();
            } else if (selectedStudentIds.length > 1) {
                // 여러 학생 선택 시 기존 할당 내역 초기화
                assignmentList.innerHTML = '';
                renderAssignmentListPlaceholder('여러 학생에게 동일한 퀘스트를 할당합니다. 퀘스트를 추가하세요.');
            } else {
                // 아무도 선택하지 않은 경우
                assignmentList.innerHTML = '';
                renderAssignmentListPlaceholder('학생을 선택하면 퀘스트 내용을 볼 수 있습니다.');
            }

            checkSaveButtonStatus();
        };

        const updateStudentSelectorText = () => {
            const count = selectedStudentIds.length;
            if (count === 0) {
                studentSelectorText.innerHTML = '- 학생 선택 -';
            } else if (count === 1) {
                const student = myStudents.find(s => s.account_id === selectedStudentIds[0]);
                studentSelectorText.innerHTML = `${student.student_name} <span class="selected-count">1</span>`;
            } else {
                studentSelectorText.innerHTML = `${count}명 선택됨 <span class="selected-count">${count}</span>`;
            }
        };

        const toggleStudentDropdown = () => {
            studentDropdown.classList.toggle('show');
        };

        const handleSelectAll = () => {
            const checkboxes = studentDropdownList.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });

            selectAllBtn.textContent = allChecked ? '전체 선택' : '전체 해제';
            handleStudentSelectionChange();
        };

        // 드롭다운 외부 클릭 시 닫기
        document.addEventListener('click', (e) => {
            if (!studentSelectorButton.contains(e.target) && !studentDropdown.contains(e.target)) {
                studentDropdown.classList.remove('show');
            }
        });

        // --- 2. 운동 마스터 목록 로드 및 카테고리 버튼 생성 ---
        const loadMasterExercises = async () => {
            // ... (기존과 동일) ...
            categorySelector.innerHTML = '<p class="loading-text">운동 목록 로딩 중...</p>';
            subCategorySelector.innerHTML = '<p class="placeholder-text">카테고리를 먼저 선택하세요.</p>';
            exerciseButtonContainer.innerHTML = '<p class="placeholder-text">세부 카테고리를 선택하세요.</p>';
            
            try {
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/master-exercises`);
                if (data.success && data.exercises) {
                    masterExercises = data.exercises;
                    
                    groupedExercises = {};
                    masterExercises.forEach(ex => {
                        const cat = ex.category || 'Other';
                        const subCat = ex.sub_category || '기타';
                        if (!groupedExercises[cat]) groupedExercises[cat] = {};
                        if (!groupedExercises[cat][subCat]) groupedExercises[cat][subCat] = [];
                        groupedExercises[cat][subCat].push(ex);
                    });
                    
                    renderCategoryButtons(Object.keys(groupedExercises));
                } else {
                    categorySelector.innerHTML = '<p class="placeholder-text">운동 목록 없음</p>';
                }
            } catch (err) {
                console.error('운동 마스터 목록 로딩 오류:', err);
                categorySelector.innerHTML = '<p class="placeholder-text">로드 오류</p>';
                // apiCall에서 이미 토스트 띄움
            }
        };
        
        // --- 2-1. 카테고리 버튼 렌더링 ---
        function renderCategoryButtons(categoryNames) {
            // ... (기존과 동일) ...
            categorySelector.innerHTML = '';
            const categoryOrder = ['Skill', 'Weight', 'Other'];
            
            categoryNames.sort((a, b) => {
                let aIdx = categoryOrder.indexOf(a);
                let bIdx = categoryOrder.indexOf(b);
                if (aIdx === -1) aIdx = 99;
                if (bIdx === -1) bIdx = 99;
                return aIdx - bIdx;
            });
            
            categoryNames.forEach(catName => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'select-btn';
                btn.textContent = catName;
                btn.dataset.category = catName;
                btn.addEventListener('click', () => {
                    categorySelector.querySelectorAll('.select-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderSubCategoryButtons(catName);
                });
                categorySelector.appendChild(btn);
            });
        }
        
        // --- 2-2. 세부 카테고리 버튼 렌더링 ---
        function renderSubCategoryButtons(categoryName) {
            // ... (기존과 동일) ...
            const subCats = groupedExercises[categoryName] ? Object.keys(groupedExercises[categoryName]) : [];
            subCategorySelector.innerHTML = '';
            exerciseButtonContainer.innerHTML = '<p class="placeholder-text">세부 카테고리를 선택하세요.</p>';
            exerciseButtonContainer.style.display = 'none';
            
            if (subCats.length === 0) {
                subCategorySelector.innerHTML = '<p class="placeholder-text">세부 카테고리 없음</p>';
                subCategorySelector.style.display = 'block';
                return;
            }
            
            subCats.forEach(subCatName => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'select-btn';
                btn.textContent = subCatName;
                btn.dataset.subCategory = subCatName;
                btn.addEventListener('click', () => {
                    subCategorySelector.querySelectorAll('.select-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderExerciseButtons(categoryName, subCatName);
                });
                subCategorySelector.appendChild(btn);
            });
            subCategorySelector.style.display = 'block';
        }

        // --- 2-3. 운동 버튼 렌더링 ---
        function renderExerciseButtons(categoryName, subCategoryName) {
            // ... (기존과 동일) ...
            const exercises = groupedExercises[categoryName]?.[subCategoryName] || [];
            exerciseButtonContainer.innerHTML = '';

            if (exercises.length === 0) {
                exerciseButtonContainer.innerHTML = '<p class="placeholder-text">운동 없음</p>';
                exerciseButtonContainer.style.display = 'block';
                return;
            }

            exercises.forEach(ex => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'select-btn add-exercise-btn';
                btn.textContent = ex.exercise_name;
                btn.dataset.exercise = JSON.stringify(ex);
                btn.addEventListener('click', () => {
                    addExerciseToList(ex);
                });
                exerciseButtonContainer.appendChild(btn);
            });
            exerciseButtonContainer.style.display = 'block';
        }

        // --- 3. 할당 목록에 운동 추가 ---
        const addExerciseToList = (exerciseData) => {
            // ... (기존과 동일) ...
            if (!exerciseData || exerciseData.exercise_id === undefined) {
                showToast('유효하지 않은 운동입니다.', false);
                return;
            }
            if (assignmentList.querySelector(`li[data-exercise-id="${exerciseData.exercise_id}"]`)) {
                showToast('이미 목록에 추가된 운동입니다.', false);
                return;
            }
            const template = document.getElementById('assignmentItemTemplate');
            const newItem = template.content.cloneNode(true).firstElementChild;
            newItem.dataset.exerciseId = exerciseData.exercise_id;
            newItem.querySelector('.exercise-name').textContent = exerciseData.exercise_name;
            newItem.querySelector('.category').textContent = `[${exerciseData.category} / ${exerciseData.sub_category || '기타'}]`;
            if (exerciseData.category !== 'Weight') {
                 const weightInput = newItem.querySelector('input[name="target_weight"]');
                 if (weightInput) { weightInput.disabled = true; weightInput.placeholder = '-'; }
            }
            if (exerciseData.category === 'Skill') {
                 const notesInput = newItem.querySelector('input[name="target_notes"]');
                 if(notesInput) notesInput.placeholder = '예: 8.0초 목표, 자세 집중';
            }
            assignmentListPlaceholder.style.display = 'none';
            assignmentList.appendChild(newItem);
            checkSaveButtonStatus();
        };
        
        // --- 3-1. 기존 할당 목록 렌더링 ---
        const renderExistingAssignment = (assignmentData) => {
            // ... (기존과 동일) ...
            const masterEx = masterExercises.find(ex => ex.exercise_name === assignmentData.exercise_name);
            const exerciseId = masterEx ? masterEx.exercise_id : null;

            if (!exerciseId) {
                console.warn(`Skipping render for unknown/deleted exercise: ${assignmentData.exercise_name}`);
                return;
            }
            if (assignmentList.querySelector(`li[data-exercise-id="${exerciseId}"]`)) {
                return;
            }

            const template = document.getElementById('assignmentItemTemplate');
            const newItem = template.content.cloneNode(true).firstElementChild;

            newItem.dataset.exerciseId = exerciseId;
            newItem.querySelector('.exercise-name').textContent = assignmentData.exercise_name;
            newItem.querySelector('.category').textContent = `[${assignmentData.category} / ${assignmentData.sub_category || '기타'}]`;
            newItem.querySelector('input[name="target_weight"]').value = assignmentData.target_weight || '';
            newItem.querySelector('input[name="target_sets"]').value = assignmentData.target_sets || '';
            newItem.querySelector('input[name="target_reps"]').value = assignmentData.target_reps || '';
            newItem.querySelector('input[name="target_notes"]').value = assignmentData.target_notes || '';

            if (assignmentData.category !== 'Weight') {
                 const weightInput = newItem.querySelector('input[name="target_weight"]');
                 if (weightInput) { weightInput.disabled = true; weightInput.placeholder = '-'; }
            }

            // ⭐️ [신규] 완료된 퀘스트는 삭제 버튼 비활성화
            const deleteBtn = newItem.querySelector('.delete-exercise-btn');
            if (assignmentData.is_completed) {
                deleteBtn.disabled = true;
                deleteBtn.dataset.isCompleted = 'true';
                deleteBtn.title = '완료된 퀘스트는 삭제할 수 없습니다';
                // 완료 표시 추가 (운동명 옆에 체크 아이콘)
                const exerciseName = newItem.querySelector('.exercise-name');
                exerciseName.innerHTML = `${assignmentData.exercise_name} <i class="fas fa-check-circle" style="color: var(--success-color); font-size: 0.9rem;" title="완료됨"></i>`;
            }

            assignmentList.appendChild(newItem);
        };
        
        // --- 3-2. 퀘스트 목록 플레이스홀더 관리 ---
        const renderAssignmentListPlaceholder = (message, showSpinner = false) => {
             // ... (기존과 동일) ...
             assignmentList.innerHTML = '';
             assignmentListPlaceholder.innerHTML = showSpinner 
                ? `<i class="fas fa-spinner fa-spin"></i> ${message}`
                : message;
             assignmentListPlaceholder.style.display = 'block';
        };

        // --- ⭐️ [신규] 3-3. 퀘스트 목록 초기화 함수 ---
        const clearAssignmentList = (confirmFirst = false) => {
            if (confirmFirst) {
                if (!confirm('현재 할당 목록을 모두 지우시겠습니까?')) return;
            }
            assignmentList.innerHTML = ''; // 목록 비우기
            renderAssignmentListPlaceholder('퀘스트를 추가하세요.');
            checkSaveButtonStatus(); // 저장 버튼 상태 갱신
            resetSelections(); // 운동 선택기 리셋
            showToast('목록이 초기화되었습니다.', true);
        };

        // --- 할당 목록에서 운동 제거 (onclick용 전역 함수) ---
        window.removeExerciseItem = (buttonElement) => {
            // ... (기존과 동일) ...
            buttonElement.closest('.assignment-item').remove();
            if (assignmentList.children.length === 0 || (assignmentList.children.length === 1 && assignmentList.children[0].tagName === 'P')) {
                 renderAssignmentListPlaceholder('퀘스트를 추가하세요.');
            }
            checkSaveButtonStatus();
        };
        
        // --- 4. ⭐️ [수정] 버튼 활성화/비활성화 체크 ---
        const checkSaveButtonStatus = () => {
            const assignmentDate = dateSelect.value;
            const hasStudents = selectedStudentIds.length > 0;

            if (hasStudents && assignmentDate) {
                 saveAssignmentsBtn.disabled = false;
                 // ⭐️ 전날 불러오기는 단일 학생 선택 시에만 활성화
                 loadPrevDayBtn.disabled = selectedStudentIds.length !== 1;
            } else {
                 saveAssignmentsBtn.disabled = true;
                 loadPrevDayBtn.disabled = true;
            }

            // ⭐️ 로딩 중 아닐 때 항상 텍스트 복구
            if (!loadPrevDayBtn.disabled && !loadPrevDayBtn.querySelector('.fa-spin')) {
                 loadPrevDayBtn.innerHTML = '<i class="fas fa-history"></i> 전날 운동 불러오기';
            }
        };

        // --- 5. ⭐️ [수정] 기존 퀘스트 목록 불러오기 (단일 학생만 지원) ---
        const loadExistingAssignments = async () => {
            const assignmentDate = dateSelect.value;

            checkSaveButtonStatus(); // ⭐️ 버튼 상태(disabled 여부)는 여기서 먼저 결정

            // ⭐️ 다중 선택 시에는 로드하지 않음
            if (selectedStudentIds.length !== 1 || !assignmentDate) {
                if (selectedStudentIds.length === 0) {
                    renderAssignmentListPlaceholder('학생을 선택하세요.');
                } else if (selectedStudentIds.length > 1) {
                    renderAssignmentListPlaceholder('여러 학생에게 동일한 퀘스트를 할당합니다. 퀘스트를 추가하세요.');
                } else {
                    renderAssignmentListPlaceholder('날짜를 선택하세요.');
                }
                return;
            }

            const studentId = selectedStudentIds[0];
            loadPrevDayBtn.disabled = true; // ⭐️ '전날 불러오기' 버튼만 일시적으로 비활성화 (로딩 중)
            renderAssignmentListPlaceholder('기존 퀘스트 로딩 중...', true);

            try {
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/teacher/assignments/${studentId}/${assignmentDate}`);

                if (data.success && data.assignments) {
                    assignmentList.innerHTML = ''; // ⭐️ 로딩 메시지 제거
                    if (data.assignments.length === 0) {
                        renderAssignmentListPlaceholder('이 날짜에 할당된 퀘스트가 없습니다.');
                    } else {
                        assignmentListPlaceholder.style.display = 'none';
                        data.assignments.forEach(renderExistingAssignment);
                    }
                } else {
                    renderAssignmentListPlaceholder('기존 퀘스트 로드 실패');
                    showToast(data.message || '기존 퀘스트 로드 실패', false);
                }
            } catch (err) {
                 renderAssignmentListPlaceholder('로드 중 오류 발생');
                 // apiCall에서 이미 토스트 띄움
            } finally {
                // ⭐️ try/catch 상관없이 '전날 불러오기' 버튼 상태 복구
                checkSaveButtonStatus();
            }
        };
        
        // --- ⭐️ [신규] 5-1. 전날 운동 불러오기 함수 (단일 학생만 지원) ---
        const loadPreviousDayAssignments = async () => {
            const currentDateStr = dateSelect.value;

            if (selectedStudentIds.length !== 1 || !currentDateStr) {
                showToast('단일 학생 선택 시에만 전날 운동을 불러올 수 있습니다.', false);
                return;
            }

            const studentId = selectedStudentIds[0];

            // 1. 어제 날짜 계산
            const currentDate = new Date(currentDateStr);
            currentDate.setDate(currentDate.getDate() - 1);
            const prevDateStr = currentDate.toISOString().split('T')[0];

            console.log(`전날(${prevDateStr}) 운동 불러오기 시도...`);
            loadPrevDayBtn.disabled = true;
            loadPrevDayBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 불러오는 중...';

            try {
                // 2. '어제 날짜'로 API 호출 (기존 API 재활용)
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/teacher/assignments/${studentId}/${prevDateStr}`);
                
                if (data.success && data.assignments) {
                    if (data.assignments.length === 0) {
                        showToast(`전날(${prevDateStr}) 할당된 운동이 없습니다.`, true);
                        clearAssignmentList(false); // 목록 비우기 (확인창 없이)
                    } else {
                        // 3. '현재 목록'을 비우고 '어제 목록'으로 렌더링
                        assignmentList.innerHTML = ''; // 기존 목록 싹 비우기
                        assignmentListPlaceholder.style.display = 'none';
                         data.assignments.forEach(a => { a.is_completed = false; });
                        data.assignments.forEach(renderExistingAssignment);
                        // ⭐️ 3초 -> 4초로 변경 (긴 메시지)
                        showToast(`✅ 전날(${prevDateStr}) 운동 ${data.assignments.length}개를 불러왔습니다. '저장하기'를 눌러야 오늘 날짜로 할당됩니다.`, true, 4000); // ⭐️ 4초로 연장
                    }
                } else {
                    showToast(`전날 운동 로드 실패: ${data.message || '오류'}`, false);
                }
            } catch (err) {
                 // apiCall에서 이미 토스트 띄움
                 console.error('loadPreviousDayAssignments error:', err);
            } finally {
                // ▼▼▼▼▼ [수정된 부분] ▼▼▼▼▼
                // ⭐️ 버튼 텍스트를 먼저 강제로 복구합니다.
                loadPrevDayBtn.innerHTML = '<i class="fas fa-history"></i> 전날 운동 불러오기';
                // ⭐️ 그 다음, 활성화/비활성화 상태를 결정합니다.
                checkSaveButtonStatus();
                // ▲▲▲▲▲ [수정된 부분] ▲▲▲▲▲
            }
        };


        // --- 6. ⭐️ [수정] 최종 할당 저장 함수 (다중 학생 지원) ---
        const saveAssignments = async () => {
            const assignmentDate = dateSelect.value;

            if (selectedStudentIds.length === 0 || !assignmentDate) {
                showToast('학생과 할당 날짜를 모두 선택해야 합니다.', false);
                return;
            }

            saveAssignmentsBtn.disabled = true;
            saveAssignmentsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 저장 중...';

            const assignments = [];
            assignmentList.querySelectorAll('.assignment-item').forEach(item => {
                const exerciseData = masterExercises.find(ex => ex.exercise_id == item.dataset.exerciseId);
                if (!exerciseData) return;
                assignments.push({
                    exercise_name: exerciseData.exercise_name,
                    category: exerciseData.category,
                    sub_category: exerciseData.sub_category || null,
                    target_weight: item.querySelector('input[name="target_weight"]').value || null,
                    target_sets: item.querySelector('input[name="target_sets"]').value || null,
                    target_reps: item.querySelector('input[name="target_reps"]').value || null,
                    target_notes: item.querySelector('input[name="target_notes"]').value || null,
                });
            });

            console.log(`Saving assignments to ${selectedStudentIds.length} students:`, assignments);

            try {
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/teacher/assign-workout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_account_ids: selectedStudentIds, // ⭐️ 다중 학생 ID 배열
                        assignment_date: assignmentDate,
                        assignments: assignments
                    })
                });

                if (data.success) {
                    const successCount = data.success_count || selectedStudentIds.length;
                    const failedCount = data.failed_count || 0;

                    if (failedCount === 0) {
                        showToast(`✅ ${successCount}명의 학생에게 데일리 운동이 저장되었습니다.`, true);
                    } else {
                        showToast(`⚠️ ${successCount}명 성공, ${failedCount}명 실패했습니다.`, false);
                    }

                    // ⭐️ 결과 상세 내역이 있으면 콘솔에 출력
                    if (data.results) {
                        console.log('할당 결과:', data.results);
                        if (data.results.failed && data.results.failed.length > 0) {
                            console.warn('실패한 학생:', data.results.failed);
                        }
                    }

                    resetSelections(); // 카테고리 선택 초기화
                } else {
                    showToast(`❌ 저장 실패: ${data.message || '알 수 없는 오류'}`, false);
                }
            } catch (err) {
                console.error('운동 할당 저장 오류:', err);
                // apiCall에서 이미 토스트 띄움
            } finally {
                saveAssignmentsBtn.disabled = false;
                saveAssignmentsBtn.innerHTML = '<i class="fas fa-save"></i> 일일 퀘스트 할당 및 수정';
            }
        };

        // --- 7. ⭐️ [수정] 이벤트 리스너 연결 ---
        yearSelect.addEventListener('change', loadMyStudents);
        studentSelectorButton.addEventListener('click', toggleStudentDropdown); // ⭐️ [신규]
        selectAllBtn.addEventListener('click', handleSelectAll); // ⭐️ [신규]
        dateSelect.addEventListener('change', loadExistingAssignments);
        saveAssignmentsBtn.addEventListener('click', saveAssignments);
        loadPrevDayBtn.addEventListener('click', loadPreviousDayAssignments); // ⭐️ [신규]
        clearAssignmentsBtn.addEventListener('click', () => clearAssignmentList(true)); // ⭐️ [신규]

        // --- 8. (신규) 8. 운동 선택기 초기화 ---
        function resetSelections() {
            // ... (기존과 동일) ...
            categorySelector.querySelectorAll('.select-btn').forEach(b => b.classList.remove('active'));
            subCategorySelector.querySelectorAll('.select-btn').forEach(b => b.classList.remove('active'));
            subCategorySelector.innerHTML = '<p class="placeholder-text">카테고리를 먼저 선택하세요.</p>';
            subCategorySelector.style.display = 'none';
            exerciseButtonContainer.innerHTML = '<p class="placeholder-text">세부 카테고리를 선택하세요.</p>';
            exerciseButtonContainer.style.display = 'none';
        }

        // --- 9. 초기 실행 (기존 '7'번) ---
        setTodayDate();
        loadMyStudents();
        loadMasterExercises();

    });
</script>

</body>
</html>

