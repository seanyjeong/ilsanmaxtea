<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>í€˜ìŠ¤íŠ¸(ìš´ë™) ëª©ë¡ ê´€ë¦¬</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb; --primary-dark:#1d4ed8;
            --light-bg: #f8fafc; --card-bg: #ffffff;
            --border-color: #e2e8f0; --text-primary:#1e293b; --text-secondary:#475569;
            --danger-color: #ef4444; --success-color: #10b981; --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light-bg); padding: 20px; margin: 0; line-height: 1.5; color: var(--text-primary); }
        .container { max-width: 900px; margin: 0 auto; }

        /* ---------- Header ---------- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            gap: 12px; flex-wrap: wrap;
            background: var(--card-bg); padding: 16px 18px; border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.6rem; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: none; border-radius: 8px; font-weight: 600; font-size: .9rem; cursor: pointer; transition: .2s; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; }
        .btn-danger { background: var(--danger-color); color: #fff; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: #e2e8f0; color: var(--text-secondary); }
        .btn-secondary:hover { background: #cbd5e1; }

        /* ---------- Card ---------- */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
        .card-title { font-size: 1.3rem; font-weight: 600; margin: 0 0 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }

        /* í¼ ìš”ì†Œ */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary); }
        .form-group input[type="text"], .form-group select {
            width: 100%; padding: 10px; font-size: 0.95rem;
            border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Pretendard', sans-serif;
        }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; grid-column: 1 / -1; }
        
        /* ìš´ë™ ëª©ë¡ í…Œì´ë¸” */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: left; vertical-align: middle; }
        th { background-color: #f1f5f9; font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: #f8fafc; }
        
        .status-badge { padding: 3px 8px; font-size: 0.8rem; font-weight: 600; border-radius: 12px; }
        .status-badge.active { background-color: var(--success-color); color: #fff; }
        .status-badge.inactive { background-color: var(--border-color); color: var(--text-secondary); }

        /* â­ï¸ [ì‹ ê·œ] ì¢…ëª© ë§¤í•‘ ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .event-mapping-group {
            display: flex; flex-wrap: wrap; gap: 8px;
            padding: 10px; background: #f8fafc;
            border: 1px solid var(--border-color); border-radius: 8px;
        }
        .event-mapping-item {
            display: flex; align-items: center; gap: 6px;
            background: #fff; padding: 6px 10px; border-radius: 6px;
            border: 1px solid var(--border-color); cursor: pointer;
            transition: all 0.2s; font-size: 0.85rem;
        }
        .event-mapping-item:hover { border-color: var(--primary-color); }
        .event-mapping-item.checked {
            background: var(--primary-color); color: #fff;
            border-color: var(--primary-color);
        }
        .event-mapping-item input[type="checkbox"] { cursor: pointer; }
        .event-tag {
            display: inline-flex; align-items: center; gap: 4px;
            background: var(--primary-color); color: #fff;
            padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;
            margin-right: 4px;
        }

        /* ë¡œë”©/ë°ì´í„° ì—†ìŒ */
        .loading, .no-data { text-align: center; padding: 30px; color: var(--text-secondary); }

        /* --- Toast Popup --- */
        .toast-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8); color: white; padding: 10px 18px; border-radius: 20px;
            font-size: 0.9rem; z-index: 1002; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
            pointer-events: none;
        }
        .toast-popup.show { opacity: 1; bottom: 40px; }
        .toast-popup.success { background-color: var(--success-color); }
        .toast-popup.error { background-color: var(--danger-color); }

        @media (max-width: 767px) {
            body { padding: 10px; }
            .header { padding: 15px; } .header h1 { font-size: 1.4rem; }
            .card { padding: 15px; } .form-grid { grid-template-columns: 1fr; }
            .btn-sm { padding: 8px 10px; font-size: 0.8rem; }
            th, td { font-size: 0.9rem; padding: 8px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-cog"></i> í€˜ìŠ¤íŠ¸(ìš´ë™) ëª©ë¡ ê´€ë¦¬</h1>
    </div>

    <div class="card" id="exerciseFormCard">
        <h4 class="card-title" id="formTitle">ìƒˆ ìš´ë™ ì¶”ê°€</h4>
        <input type="hidden" id="editingExerciseId">
        <div class="form-grid">
            <div class="form-group full-width">
                <label for="exerciseName">ìš´ë™ëª… (í•„ìˆ˜)</label>
                <input type="text" id="exerciseName" placeholder="ì˜ˆ: 10m ì™•ë³µë‹¬ë¦¬ê¸°">
            </div>
            <div class="form-group">
                <label for="exerciseCategory">ì¹´í…Œê³ ë¦¬ (ì§ì ‘ ì…ë ¥ ë˜ëŠ” ì„ íƒ)</label>
                <input type="text" id="exerciseCategory" list="categoryDatalist" placeholder="ì˜ˆ: Skill, Weight, Other">
                <datalist id="categoryDatalist"></datalist>
            </div>
            <div class="form-group">
                <label for="exerciseSubCategory">ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ (ì§ì ‘ ì…ë ¥ ë˜ëŠ” ì„ íƒ)</label>
                <input type="text" id="exerciseSubCategory" list="subCategoryDatalist" placeholder="ì˜ˆ: ë‹¬ë¦¬ê¸°, ìƒì²´, í•˜ì²´">
                <datalist id="subCategoryDatalist"></datalist>
            </div>
            <div class="form-group">
                <label for="exerciseExpValue">íšë“ ê²½í—˜ì¹˜ (EXP) â­</label>
                <input type="number" id="exerciseExpValue" min="1" max="100" value="1" placeholder="1">
            </div>
            <div class="form-group">
                <label for="exerciseStatus">ìƒíƒœ</label>
                <select id="exerciseStatus">
                    <option value="1">í™œì„±í™” (ë³´ì—¬ì£¼ê¸°)</option>
                    <option value="0">ë¹„í™œì„±í™” (ìˆ¨ê¸°ê¸°)</option>
                </select>
            </div>
            <div class="form-group full-width">
                <label>ê´€ë ¨ ì¢…ëª© ì„ íƒ (ìë™ ë¶„ë°°ìš©)</label>
                <div class="event-mapping-group" id="eventMappingGroup">
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">ì¢…ëª© ë¡œë”© ì¤‘...</span>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display: none;">ì·¨ì†Œ</button>
                <button type="button" id="saveExerciseBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> ì €ì¥í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <h4 class="card-title">ìš´ë™ ëª©ë¡</h4>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ìš´ë™ëª…</th>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>ì„¸ë¶€</th>
                        <th>ê´€ë ¨ ì¢…ëª©</th>
                        <th>ê²½í—˜ì¹˜</th>
                        <th>ìƒíƒœ</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="exerciseListBody">
                    <tr>
                        <td colspan="6" class="loading" id="listLoading"><i class="fas fa-spinner fa-spin"></i> ëª©ë¡ ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<template id="exerciseItemTemplate">
    <tr data-exercise-id="{{exercise_id}}">
        <td class="name">ìš´ë™ëª…</td>
        <td class="category">ì¹´í…Œê³ ë¦¬</td>
        <td class="sub-category">ì„¸ë¶€</td>
        <td class="event-mappings">-</td>
        <td class="exp-value" style="font-weight: 600; color: var(--primary-color);">+1 EXP</td>
        <td><span class="status-badge">ìƒíƒœ</span></td>
        <td>
            <button type="button" class="btn btn-secondary btn-sm edit-btn">
                <i class="fas fa-edit"></i>
            </button>
            <button type="button" class="btn btn-danger btn-sm delete-btn">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</template>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ì„œë²„ ë° ì¸ì¦ ---
        const SVR_JUNGSI = 'https://supermax.kr';
        const LOGIN_PAGE = 'admin_login.html';

        // --- HTML ìš”ì†Œ ---
        const formTitle = document.getElementById('formTitle');
        const editingExerciseId = document.getElementById('editingExerciseId');
        const exerciseName = document.getElementById('exerciseName');
        const exerciseCategory = document.getElementById('exerciseCategory');
        const exerciseSubCategory = document.getElementById('exerciseSubCategory');
        const exerciseExpValue = document.getElementById('exerciseExpValue');
        const exerciseStatus = document.getElementById('exerciseStatus');
        const categoryDatalist = document.getElementById('categoryDatalist');
        const subCategoryDatalist = document.getElementById('subCategoryDatalist');
        const saveExerciseBtn = document.getElementById('saveExerciseBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const exerciseListBody = document.getElementById('exerciseListBody');
        const listLoading = document.getElementById('listLoading');
        const eventMappingGroup = document.getElementById('eventMappingGroup');

        let allExercises = []; // ì „ì²´ ìš´ë™ ëª©ë¡ ìºì‹œ
        let practicalEvents = []; // â­ï¸ [ì‹ ê·œ] ì‹¤ê¸° ì¢…ëª© ëª©ë¡
        let exerciseEventMappings = {}; // â­ï¸ [ì‹ ê·œ] ìš´ë™ë³„ ì¢…ëª© ë§¤í•‘ (exercise_id -> [{event_id, event_name}])

        // --- ì¸ì¦ í™•ì¸ (ê´€ë¦¬ì) ---
        const getToken = () => localStorage.getItem('jwt_token');
        const token = getToken();
        let currentUser = null;
        if (!token) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); window.location.href = LOGIN_PAGE; return; }
        try {
            // ... (í† í° ë””ì½”ë”©) ...
            const payloadBase64Url = token.split('.')[1];
            const payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
            const decodedString = new TextDecoder().decode(Uint8Array.from(atob(payloadBase64), c => c.charCodeAt(0)));
            currentUser = JSON.parse(decodedString);
            
            // â­ï¸ ê´€ë¦¬ ê¶Œí•œ í™•ì¸
            const isManagement = currentUser && (
                (currentUser.position && ['ì›ì¥', 'ë¶€ì›ì¥', 'íŒ€ì¥'].includes(currentUser.position)) ||
                currentUser.role === 'admin'
            );
            if (!isManagement) {
                alert('ì´ í˜ì´ì§€ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = 'index.html'; // ê´€ë¦¬ì ë©”ì¸ìœ¼ë¡œ
                return;
            }
        } catch (e) {
            console.error('í† í° ì²˜ë¦¬ ì‹¤íŒ¨:', e); alert('ì¸ì¦ ì •ë³´ ì˜¤ë¥˜.'); window.location.href = LOGIN_PAGE; return;
        }

        // --- API í˜¸ì¶œ í•¨ìˆ˜ (ì¸ì¦ í¬í•¨) ---
        const apiCall = async (url, options = {}) => {
            const currentToken = getToken();
            if (!currentToken) { alert('ë¡œê·¸ì¸ ì„¸ì…˜ ë§Œë£Œ'); window.location.href = LOGIN_PAGE; throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ'); }
            options.headers = { ...options.headers, 'Authorization': `Bearer ${currentToken}` };
            try {
                const response = await fetch(url, options);
                if (response.status === 401) {
                     alert('ë¡œê·¸ì¸ ì„¸ì…˜ ë§Œë£Œ'); localStorage.removeItem('jwt_token'); window.location.href = LOGIN_PAGE; throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ');
                } else if (response.status === 403) {
                     alert('ì´ ê¸°ëŠ¥ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); throw new Error('ê¶Œí•œ ì—†ìŒ');
                }
                if (!response.ok) {
                    let errorMsg = `HTTP ì˜¤ë¥˜ ${response.status}`; try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch (_) {} throw new Error(errorMsg);
                }
                if (response.status === 204) { return { success: true }; }
                 return await response.json();
            } catch (error) {
                console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', url, error);
                if (error.message !== 'ë¡œê·¸ì¸ ë§Œë£Œ' && error.message !== 'ê¶Œí•œ ì—†ìŒ') {
                    showToast(`ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜: ${error.message}`, false);
                }
                throw error;
            }
        };

        // --- Toast Popup í•¨ìˆ˜ ---
        const showToast = (message, isSuccess = true) => { const el = document.createElement('div'); el.textContent = message; el.className = `toast-popup ${isSuccess ? 'success' : 'error'}`; document.body.appendChild(el); setTimeout(() => el.classList.add('show'), 10); setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 2500); };

        // --- 0. ì‹¤ê¸° ì¢…ëª© ëª©ë¡ ë¡œë“œ ---
        const loadPracticalEvents = async () => {
            eventMappingGroup.innerHTML = '<span style="color: var(--text-secondary); font-size: 0.9rem;">ì¢…ëª© ë¡œë”© ì¤‘...</span>';
            try {
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/admin/practical-events`);
                if (data.success && data.events) {
                    practicalEvents = data.events;
                    renderEventMappingCheckboxes();
                } else {
                    eventMappingGroup.innerHTML = '<span style="color: var(--danger-color); font-size: 0.9rem;">ì¢…ëª© ë¡œë“œ ì‹¤íŒ¨</span>';
                }
            } catch (err) {
                console.error('ì‹¤ê¸° ì¢…ëª© ë¡œë”© ì˜¤ë¥˜:', err);
                eventMappingGroup.innerHTML = '<span style="color: var(--danger-color); font-size: 0.9rem;">ì¢…ëª© ë¡œë“œ ì˜¤ë¥˜</span>';
            }
        };

        // --- 0-1. ì¢…ëª© ë§¤í•‘ ì²´í¬ë°•ìŠ¤ ë Œë”ë§ ---
        const renderEventMappingCheckboxes = () => {
            eventMappingGroup.innerHTML = '';
            if (practicalEvents.length === 0) {
                eventMappingGroup.innerHTML = '<span style="color: var(--text-secondary); font-size: 0.9rem;">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
                return;
            }
            practicalEvents.forEach(event => {
                const item = document.createElement('label');
                item.className = 'event-mapping-item';
                item.innerHTML = `
                    <input type="checkbox" value="${event.event_id}" data-event-name="${event.event_name}">
                    ${event.event_name}
                `;
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', () => {
                    item.classList.toggle('checked', checkbox.checked);
                });
                eventMappingGroup.appendChild(item);
            });
        };

        // --- 0-2. ì„ íƒëœ ì¢…ëª© ID ë°°ì—´ ê°€ì ¸ì˜¤ê¸° ---
        const getSelectedEventMappings = () => {
            const checkboxes = eventMappingGroup.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => ({
                event_id: parseInt(cb.value),
                priority: 2 // ê¸°ë³¸ ìš°ì„ ìˆœìœ„
            }));
        };

        // --- 0-3. ì¢…ëª© ì²´í¬ë°•ìŠ¤ ì„ íƒ ìƒíƒœ ì„¤ì • ---
        const setEventMappingCheckboxes = (eventIds) => {
            eventMappingGroup.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                const isChecked = eventIds.includes(parseInt(cb.value));
                cb.checked = isChecked;
                cb.closest('.event-mapping-item').classList.toggle('checked', isChecked);
            });
        };

        // --- 1. ìš´ë™ ëª©ë¡ ë° ì¹´í…Œê³ ë¦¬ ë¡œë“œ ---
        const loadAllExercises = async () => {
            listLoading.style.display = 'table-row';
            exerciseListBody.innerHTML = '';
            exerciseListBody.appendChild(listLoading);
            try {
                // 1.1. ì „ì²´ ìš´ë™ ëª©ë¡ (í™œì„±/ë¹„í™œì„± í¬í•¨)
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/admin/master-exercises`);
                if (data.success && data.exercises) {
                    allExercises = data.exercises;

                    // â­ï¸ [ì‹ ê·œ] ê° ìš´ë™ì˜ ì¢…ëª© ë§¤í•‘ ë¡œë“œ
                    await loadAllExerciseEventMappings(allExercises);

                    renderExerciseList(allExercises);
                } else {
                    exerciseListBody.innerHTML = '<tr><td colspan="7" class="no-data">ìš´ë™ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</td></tr>';
                }

                // 1.2. ê¸°ì¡´ ì¹´í…Œê³ ë¦¬/ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ ëª©ë¡ (Datalistìš©)
                const catData = await apiCall(`${SVR_JUNGSI}/jungsi/admin/exercise-categories`);
                if (catData.success) {
                    populateDatalist(categoryDatalist, catData.categories);
                    populateDatalist(subCategoryDatalist, catData.subCategories);
                }
            } catch (err) {
                 listLoading.style.display = 'none';
                 console.error('loadAllExercises error caught:', err.message);
            }
        };

        // --- 1-1. ëª¨ë“  ìš´ë™ì˜ ì¢…ëª© ë§¤í•‘ ë¡œë“œ ---
        const loadAllExerciseEventMappings = async (exercises) => {
            exerciseEventMappings = {};
            // ë³‘ë ¬ë¡œ ëª¨ë“  ìš´ë™ì˜ ë§¤í•‘ ì¡°íšŒ
            const promises = exercises.map(async (ex) => {
                try {
                    const data = await apiCall(`${SVR_JUNGSI}/jungsi/admin/exercise-event-mappings/${ex.exercise_id}`);
                    if (data.success && data.mappings) {
                        exerciseEventMappings[ex.exercise_id] = data.mappings;
                    }
                } catch (err) {
                    console.warn(`ìš´ë™ ${ex.exercise_id} ì¢…ëª© ë§¤í•‘ ë¡œë“œ ì‹¤íŒ¨:`, err);
                }
            });
            await Promise.all(promises);
        };

        // --- 2. ëª©ë¡ ë Œë”ë§ ---
        const renderExerciseList = (exercises) => {
            listLoading.style.display = 'none';
            exerciseListBody.innerHTML = '';
            if (exercises.length === 0) {
                exerciseListBody.innerHTML = '<tr><td colspan="7" class="no-data">ë“±ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            const template = document.getElementById('exerciseItemTemplate');
            exercises.forEach(ex => {
                const item = template.content.cloneNode(true).firstElementChild;
                item.dataset.exerciseId = ex.exercise_id;
                item.querySelector('.name').textContent = ex.exercise_name;
                item.querySelector('.category').textContent = ex.category || '-';
                item.querySelector('.sub-category').textContent = ex.sub_category || '-';
                item.querySelector('.exp-value').textContent = `+${ex.exp_value || 1} EXP`;

                // â­ï¸ [ì‹ ê·œ] ì¢…ëª© ë§¤í•‘ íƒœê·¸ í‘œì‹œ
                const mappingsCell = item.querySelector('.event-mappings');
                const mappings = exerciseEventMappings[ex.exercise_id] || [];
                if (mappings.length > 0) {
                    mappingsCell.innerHTML = mappings.map(m =>
                        `<span class="event-tag">${m.event_name}</span>`
                    ).join('');
                } else {
                    mappingsCell.innerHTML = '<span style="color: var(--text-secondary); font-size: 0.8rem;">-</span>';
                }

                const statusBadge = item.querySelector('.status-badge');
                if (ex.is_active) {
                    statusBadge.textContent = 'í™œì„±';
                    statusBadge.classList.add('active');
                } else {
                    statusBadge.textContent = 'ë¹„í™œì„±';
                    statusBadge.classList.add('inactive');
                }

                item.querySelector('.edit-btn').addEventListener('click', () => startEdit(ex));
                item.querySelector('.delete-btn').addEventListener('click', () => deleteExercise(ex.exercise_id, ex.exercise_name));

                exerciseListBody.appendChild(item);
            });
        };
        
        // --- 3. Datalist ì±„ìš°ê¸° ---
        const populateDatalist = (datalistElement, items) => {
            datalistElement.innerHTML = '';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                datalistElement.appendChild(option);
            });
        };

        // --- 4. í¼ ì´ˆê¸°í™” ---
        const resetForm = () => {
            formTitle.textContent = 'ìƒˆ ìš´ë™ ì¶”ê°€';
            editingExerciseId.value = '';
            exerciseName.value = '';
            exerciseCategory.value = '';
            exerciseSubCategory.value = '';
            exerciseExpValue.value = '1'; // ê¸°ë³¸ê°’ 1 EXP
            exerciseStatus.value = '1'; // ê¸°ë³¸ê°’ 'í™œì„±í™”'
            saveExerciseBtn.innerHTML = '<i class="fas fa-save"></i> ì €ì¥í•˜ê¸°';
            saveExerciseBtn.disabled = false;
            cancelEditBtn.style.display = 'none';
            // â­ï¸ [ì‹ ê·œ] ì¢…ëª© ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
            setEventMappingCheckboxes([]);
        };

        // --- 5. ìˆ˜ì • ì‹œì‘ ---
        const startEdit = (exercise) => {
            formTitle.textContent = 'ìš´ë™ ìˆ˜ì •';
            editingExerciseId.value = exercise.exercise_id;
            exerciseName.value = exercise.exercise_name;
            exerciseCategory.value = exercise.category || '';
            exerciseSubCategory.value = exercise.sub_category || '';
            exerciseExpValue.value = exercise.exp_value || 1;
            exerciseStatus.value = exercise.is_active ? '1' : '0';
            saveExerciseBtn.innerHTML = '<i class="fas fa-edit"></i> ìˆ˜ì • ì™„ë£Œ';
            cancelEditBtn.style.display = 'inline-flex';

            // â­ï¸ [ì‹ ê·œ] í•´ë‹¹ ìš´ë™ì˜ ì¢…ëª© ë§¤í•‘ ì²´í¬ë°•ìŠ¤ ì„¤ì •
            const mappings = exerciseEventMappings[exercise.exercise_id] || [];
            const mappedEventIds = mappings.map(m => m.event_id);
            setEventMappingCheckboxes(mappedEventIds);

            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- 6. ì €ì¥ (ì¶”ê°€/ìˆ˜ì •) ---
        const saveExercise = async () => {
            const id = editingExerciseId.value;
            const name = exerciseName.value.trim();
            const category = exerciseCategory.value.trim() || 'Other';
            const subCategory = exerciseSubCategory.value.trim() || null;
            const expValue = parseInt(exerciseExpValue.value) || 1;
            const isActive = exerciseStatus.value === '1';
            const selectedEventMappings = getSelectedEventMappings(); // â­ï¸ [ì‹ ê·œ]

            if (!name) {
                showToast('ìš´ë™ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.', false);
                return;
            }

            if (expValue < 1 || expValue > 100) {
                showToast('ê²½í—˜ì¹˜ëŠ” 1~100 ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.', false);
                return;
            }

            saveExerciseBtn.disabled = true;
            saveExerciseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...';

            try {
                const url = id
                    ? `${SVR_JUNGSI}/jungsi/admin/master-exercises/${id}` // ìˆ˜ì •
                    : `${SVR_JUNGSI}/jungsi/admin/master-exercises`; // ì¶”ê°€
                const method = id ? 'PUT' : 'POST';

                const result = await apiCall(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        exercise_name: name,
                        category: category,
                        sub_category: subCategory,
                        exp_value: expValue,
                        is_active: isActive
                    })
                });

                // â­ï¸ [ì‹ ê·œ] ì¢…ëª© ë§¤í•‘ ì—…ë°ì´íŠ¸ (ìˆ˜ì • ì‹œ ë˜ëŠ” ì¶”ê°€ í›„)
                const exerciseIdToUpdate = id || result.exercise_id;
                if (exerciseIdToUpdate) {
                    await apiCall(`${SVR_JUNGSI}/jungsi/admin/exercise-event-mappings/${exerciseIdToUpdate}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            event_mappings: selectedEventMappings
                        })
                    });
                }

                showToast(id ? 'âœ… ìš´ë™ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'âœ… ìƒˆ ìš´ë™ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
                resetForm();
                loadAllExercises(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

            } catch (err) {
                 console.error('saveExercise error caught:', err.message);
                 // apiCallì—ì„œ ì´ë¯¸ í† ìŠ¤íŠ¸ ë„ì›€
            } finally {
                 saveExerciseBtn.disabled = false;
                 // resetFormì—ì„œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µêµ¬
            }
        };

        // --- 7. ì‚­ì œ ---
        const deleteExercise = async (id, name) => {
            try {
                // â­ï¸ [ì‹ ê·œ] ë¨¼ì € ì‚¬ìš© ì—¬ë¶€ í™•ì¸
                const usageData = await apiCall(`${SVR_JUNGSI}/jungsi/admin/master-exercises/${id}/check-usage`);

                if (usageData.success && usageData.inUse) {
                    // ì‚¬ìš© ì¤‘ì¸ ê²½ìš° - ì‚­ì œ ë¶ˆê°€, ê²½ê³  í‘œì‹œ
                    alert(
                        `âŒ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n\n` +
                        `[${name}] í€˜ìŠ¤íŠ¸ëŠ” í˜„ì¬ ${usageData.assignmentCount}ê±´ì˜ í•™ìƒ í• ë‹¹ ë‚´ì—­ì—ì„œ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.\n\n` +
                        `ğŸ’¡ ëŒ€ì‹  'ë¹„í™œì„±í™”'ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ í• ë‹¹ì—ì„œ ìˆ¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
                    );
                    return;
                }

                // ì‚¬ìš© ì¤‘ì´ ì•„ë‹Œ ê²½ìš° - ì‚­ì œ ì§„í–‰
                if (!confirm(`[${name}] í€˜ìŠ¤íŠ¸ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }

                await apiCall(`${SVR_JUNGSI}/jungsi/admin/master-exercises/${id}`, {
                    method: 'DELETE'
                });
                showToast('ğŸ—‘ï¸ í€˜ìŠ¤íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', true);
                loadAllExercises(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

            } catch (err) {
                 console.error('deleteExercise error caught:', err.message);
                 // apiCallì—ì„œ ì´ë¯¸ í† ìŠ¤íŠ¸ í‘œì‹œë¨
            }
        };

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        saveExerciseBtn.addEventListener('click', saveExercise);
        cancelEditBtn.addEventListener('click', resetForm);

        // --- ì´ˆê¸° ì‹¤í–‰ ---
        loadPracticalEvents(); // â­ï¸ [ì‹ ê·œ] ì‹¤ê¸° ì¢…ëª© ëª©ë¡ ë¨¼ì € ë¡œë“œ
        loadAllExercises();
    });
</script>

</body>
</html>
