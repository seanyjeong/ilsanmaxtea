<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>I-MAX_instructor</title>

  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root { --primary:#2563eb; --dark:#1e1e2e; --light:#f8f9fa; --gray:#adb5bd; --gray-light:#e9ecef; --danger:#ef4444; --info:#0ea5e9; --success:#10b981; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;width:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--light);color:var(--dark);display:flex;flex-direction:column;}
    #contentFrame{flex:1;border:none;width:100%;overflow-y:auto;}
    .bottom-nav{flex-shrink:0;display:flex;justify-content:space-around;align-items:center;width:100%;height:70px;background:#fff;border-top:1px solid var(--gray-light);box-shadow:0 -4px 12px rgba(0,0,0,.05);padding-bottom:env(safe-area-inset-bottom);position:relative;z-index:100;}
    .nav-button{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-decoration:none;color:var(--gray);font-size:11px;padding:8px 0;transition:all .3s;position:relative;}
    .nav-button i{font-size:22px;margin-bottom:4px}
    .nav-button.active{color:var(--primary)}
    .nav-button.active::after{content:'';position:absolute;bottom:0;width:24px;height:3px;background:var(--primary);border-radius:2px}
    .nav-button.restricted-access{display:none}
    .nav-button.restricted-access.assignment-menu{color:var(--danger)}
    .nav-button.restricted-access.assignment-menu.active::after{background:var(--danger)}
    .nav-button.restricted-access.announcement-menu{color:var(--info)}
    .nav-button.restricted-access.announcement-menu.active::after{background:var(--info)}
    .nav-button.record-view-menu.active{color:var(--success)}
    .nav-button.record-view-menu.active::after{background:var(--success)}
    .nav-button.restricted-access.show{display:flex}
    .loading{display:none;position:absolute;top:0;left:0;width:100%;height:3px;background:linear-gradient(90deg,var(--primary),var(--danger));z-index:1000;animation:loading 1.5s infinite;}
    @keyframes loading{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    /* 로그아웃 버튼 */
    .logout-btn{display:none;position:fixed;top:12px;right:12px;width:40px;height:40px;background:rgba(239,68,68,0.9);color:#fff;border:none;border-radius:50%;font-size:18px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:999;transition:all .3s;}
    .logout-btn:active{transform:scale(0.95);background:rgba(220,38,38,0.9);}
    .logout-btn.show{display:flex;align-items:center;justify-content:center;}
  </style>
</head>
<body>
  <div class="loading" id="loadingIndicator"></div>

  <!-- 로그아웃 버튼 (우측 상단) -->
  <button id="logoutBtn" class="logout-btn" onclick="handleLogout()">
    <i class="fa-solid fa-right-from-bracket"></i>
  </button>

  <!-- 모든 화면은 이 iframe 안에서만 바뀜 (껍데기 고정) -->
  <iframe id="contentFrame" src="" name="contentFrame"></iframe>

  <nav class="bottom-nav">
    <a href="#" id="nav-assign" class="nav-button active" target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-clipboard-list"></i><span>운동 할당</span></a>
    <a href="#" id="nav-notes"  class="nav-button"        target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-file-medical"></i><span>학생 메모</span></a>
    <a href="#" id="nav-list"   class="nav-button"        target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-users"></i><span>학생 명단</span></a>
    <a href="#" id="nav-view"   class="nav-button record-view-menu" target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-clipboard-check"></i><span>기록 열람</span></a>
    <a href="#" id="announcementMenu" class="nav-button restricted-access announcement-menu" target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-bullhorn"></i><span>공지 관리</span></a>
    <a href="#" id="assignmentMenu"   class="nav-button restricted-access assignment-menu"   target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-user-shield"></i><span>반 배정</span></a>
  </nav>

  <script>
    // ===== 0) 배포 버전 (문자열만 바꿔서 관리) =====
    const APP_VERSION = '2025-11-26-ADMIN-03';
    const LOGIN_PAGE  = 'admin_login.html';

    // 버전 쿼리 헬퍼
    const vq = p => `${p}?v=${encodeURIComponent(APP_VERSION)}`;

    // 로딩바 & 탭 활성화
    function setActive(el){
      document.getElementById('loadingIndicator').style.display='block';
      document.querySelectorAll('.nav-button').forEach(b=>b.classList.remove('active'));
      el.classList.add('active');
      const frame = document.getElementById('contentFrame');
      const onload = () => {
        document.getElementById('loadingIndicator').style.display='none';
        frame.removeEventListener('load', onload);
      };
      frame.addEventListener('load', onload);
    }

    // 하단 네비 보이기/숨기기
    const bottomNav = document.querySelector('.bottom-nav');
    function showNav(show){ bottomNav.style.display = show ? 'flex' : 'none'; }

    // 로그아웃 버튼 보이기/숨기기
    const logoutBtn = document.getElementById('logoutBtn');
    function showLogoutBtn(show){
      if(show) logoutBtn.classList.add('show');
      else logoutBtn.classList.remove('show');
    }

    // 로그아웃 처리
    function handleLogout(){
      if(confirm('로그아웃 하시겠습니까?')){
        localStorage.removeItem('jwt_token');
        applyRoleMenus(null);
        showNav(false);
        showLogoutBtn(false);
        document.getElementById('contentFrame').src = routes.login;
      }
    }

    // JWT 파서(안전)
    function parseJWT(token){
      try{
        const base64 = token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');
        const json   = decodeURIComponent(atob(base64).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        return JSON.parse(json);
      }catch(e){ return null; }
    }

    // 권한 메뉴 표시
    function applyRoleMenus(payload){
      const announcementMenu = document.getElementById('announcementMenu');
      const assignmentMenu   = document.getElementById('assignmentMenu');
      const managementPositions = ['원장','부원장','팀장'];

      // 기본 숨김
      announcementMenu?.classList.remove('show');
      assignmentMenu?.classList.remove('show');

      if (!payload) return;

      if (payload.position && managementPositions.includes(payload.position)) {
        announcementMenu?.classList.add('show');
      }
      if ((payload.position && managementPositions.includes(payload.position)) || payload.userid === 'sean8320') {
        assignmentMenu?.classList.add('show');
      }
    }

    // 라우트 설정 + 링크 주입
    const routes = {
      assign: vq('admin_assign_workout.html'),
      notes:  vq('admin_student_notes.html'),
      list:   vq('admin_student_dashboard.html'),
      view:   vq('admin_student_records_view.html'),
      ann:    vq('admin_student_announcements.html'),
      clas:   vq('admin_student_assignment.html'),
      welcome:vq('welcome.html'),
      login:  vq(LOGIN_PAGE)
    };
    function injectNavHrefs(){
      document.getElementById('nav-assign').href  = routes.assign;
      document.getElementById('nav-notes').href   = routes.notes;
      document.getElementById('nav-list').href    = routes.list;
      document.getElementById('nav-view').href    = routes.view;
      document.getElementById('announcementMenu').href = routes.ann;
      document.getElementById('assignmentMenu').href   = routes.clas;
    }

    // 초기 진입: 토큰 유무에 따라 iframe만 바꿈 (껍데기 고정)
    (function initShell(){
      injectNavHrefs();
      const frame  = document.getElementById('contentFrame');
      const token  = localStorage.getItem('jwt_token');

      if (!token){
        // 토큰 없음 → 로그인 화면을 iframe에 띄우고, 네비 숨김
        showNav(false);
        showLogoutBtn(false);
        frame.src = routes.login;
        return;
      }

      const payload = parseJWT(token);
      if (!payload || payload.role === 'student'){
        alert('관리자/선생님 계정으로 로그인해주세요.');
        localStorage.removeItem('jwt_token');
        showNav(false);
        showLogoutBtn(false);
        frame.src = routes.login;
        return;
      }

      // 토큰 정상 → 권한 메뉴 반영 + 네비 보이기 + 로그아웃 버튼 보이기 + 기본 화면 로드
      applyRoleMenus(payload);
      showNav(true);
      showLogoutBtn(true);
      frame.src = routes.assign;
    })();

    // 로그인/로그아웃 결과는 자식 iframe이 부모에 postMessage로 알려줌
    window.addEventListener('message', (e) => {
      // 동일 오리진만 허용 (필요 시 e.origin 검사 강화 가능)
      const msg = e.data;
      if (!msg || !msg.type) return;

      if (msg.type === 'LOGIN_OK'){
        // 로그인 페이지가 토큰을 localStorage에 저장한 상태여야 함
        const token = localStorage.getItem('jwt_token');
        const payload = parseJWT(token);

        if (!payload || payload.role === 'student'){
          alert('관리자/선생님 계정으로 로그인해주세요.');
          localStorage.removeItem('jwt_token');
          showNav(false);
          showLogoutBtn(false);
          document.getElementById('contentFrame').src = routes.login;
          return;
        }

        // 권한 메뉴 반영 + 네비 보이기 + 로그아웃 버튼 보이기 + 목표 화면 전환
        applyRoleMenus(payload);
        showNav(true);
        showLogoutBtn(true);
        document.getElementById('contentFrame').src = routes.assign;
      }

      if (msg.type === 'LOGOUT_OK'){
        localStorage.removeItem('jwt_token');
        applyRoleMenus(null);
        showNav(false);
        showLogoutBtn(false);
        document.getElementById('contentFrame').src = routes.login;
      }
    });

    // ===== 4) 버전이 바뀐 경우에만 기존 SW 해제 (admin 전용 키) =====
    (async function oneTimeUnregOnVersionChange(){
      try{
        const KEY='imax_admin_sw_version';
        if('serviceWorker' in navigator){
          const saved=localStorage.getItem(KEY);
          if(saved!==APP_VERSION){
            const regs=await navigator.serviceWorker.getRegistrations();
            // (동일 오리진에 여러 SW가 있을 수 있으므로 일단 전체 해제)
            await Promise.all(regs.map(r => r.unregister()));
            localStorage.setItem(KEY, APP_VERSION);
          }
        }
      }catch(_){}
    })();

    // ===== 5) 관리자 영역 SW 등록 (스코프를 /admin 로 제한) =====
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/admin/sw.js', { scope: '/admin/' })
        .then(reg => reg.update?.())
        .catch(err => console.log('Service Worker 등록 실패:', err));
    }

    // ===== 6) 새 SW가 컨트롤 잡으면 한 번만 자동 새로고침 =====
    (function autoReloadOnce(){
      let reloaded=false;
      if('serviceWorker' in navigator){
        navigator.serviceWorker.addEventListener('controllerchange',()=>{
          if(reloaded) return;
          reloaded=true;
          location.reload();
        });
      }
    })();
  </script>
</body>
</html>








