<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>í•™ìƒ íŠ¹ì´ì‚¬í•­ ë©”ëª¨ (ì„ ìƒë‹˜)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb; --primary-dark:#1d4ed8;
            --light-bg: #f8fafc; --card-bg: #ffffff;
            --border-color: #e2e8f0; --text-primary:#1e293b; --text-secondary:#475569;
            --danger-color: #ef4444; --success-color: #10b981; --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            /* â­ï¸ ë¶€ìƒ ì²™ë„ìš© ë…¸ë€ìƒ‰ ì¶”ê°€ */
            --yellow-color: #facc15; 
        }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light-bg); padding: 20px; margin: 0; line-height: 1.5; color: var(--text-primary); }
        .container { max-width: 900px; margin: 0 auto; }

        /* ---------- Header & Controls ---------- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            gap: 12px; flex-wrap: wrap;
            background: var(--card-bg); padding: 16px 18px; border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.6rem; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .chip { display: inline-flex; align-items: center; gap: 6px; background: var(--light-bg); padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        .chip label { font-size: .9rem; color: var(--text-secondary); white-space: nowrap; }
        select { padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: #fff; font-size: .95rem; min-width: 150px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: none; border-radius: 8px; font-weight: 600; font-size: .9rem; cursor: pointer; transition: .2s; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; }

        /* ---------- Card ---------- */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
        .card-title { font-size: 1.3rem; font-weight: 600; margin: 0 0 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        
        /* ---------- 2ë‹¨ ë ˆì´ì•„ì›ƒ ---------- */
        .memo-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .memo-layout { grid-template-columns: 1fr 1fr; } }
        
        /* í¼ ìš”ì†Œ */
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .form-group label { font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary); }
        .form-group textarea {
            width: 100%; min-height: 120px; padding: 10px; font-size: 0.95rem;
            border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Pretendard', sans-serif;
            resize: vertical;
        }
        .form-group select { width: 100%; }

        /* â–¼â–¼â–¼ ë¶€ìƒ ì²™ë„ ìŠ¤íƒ€ì¼ (í¼ ë‚´ë¶€) â–¼â–¼â–¼ */
        .injury-scale-group {
            display: none; /* â­ï¸ í‰ì†Œì—” ìˆ¨ê¹€ */
            background-color: #fffbe6;
            border: 1px solid var(--warning-color);
            border-radius: 8px;
            padding: 10px 15px;
        }
        .injury-scale-group label { color: #b45309; }
        .injury-scale-options {
            display: flex; justify-content: space-around; margin-top: 5px;
        }
        .injury-scale-options label {
            display: flex; align-items: center; gap: 5px;
            font-size: 0.9rem; color: var(--text-primary); cursor: pointer;
        }
        .injury-scale-options input[type="radio"] {
            accent-color: var(--primary-color);
        }
        /* â–²â–²â–² ë¶€ìƒ ì²™ë„ ìŠ¤íƒ€ì¼ (í¼ ë‚´ë¶€) â–²â–²â–² */
        
        /* ë©”ëª¨ ì´ë ¥ (ìš°ì¸¡) */
        .note-history-list { list-style: none; padding: 0; margin: 0; max-height: 500px; overflow-y: auto; }
        .note-item {
            background: #f8fafc; border: 1px solid var(--border-color);
            border-radius: 8px; padding: 12px; margin-bottom: 10px;
            position: relative; /* â­ï¸ ì‚­ì œ ë²„íŠ¼ìš© */
        }
        .note-header {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;
            padding-bottom: 8px; border-bottom: 1px dashed var(--border-color);
            padding-right: 30px; 
        }
        .note-header .teacher-name { font-weight: 600; color: var(--text-primary); }
        .note-header .category {
            background: var(--warning-color); color: white; font-weight: 600;
            font-size: 0.75rem; padding: 2px 6px; border-radius: 4px;
        }

        /* â–¼â–¼â–¼ â­ï¸ (ìˆ˜ì •) ë¶€ìƒ ì²™ë„ë³„ ë±ƒì§€ ìƒ‰ìƒ (FM ìŠ¤íƒ€ì¼) â–¼â–¼â–¼ */
        .note-header .category.injury-level-1 { 
            background-color: var(--yellow-color); 
            color: var(--text-primary); /* ë…¸ë‘ ë°”íƒ•ì—” ê²€ì€ ê¸€ì”¨ */
        } /* (ê²½ë¯¸: ë…¸ë‘) */
        .note-header .category.injury-level-2 { 
            background-color: var(--warning-color); 
        } /* (ì¤‘ì¦: ì£¼í™©) */
        .note-header .category.injury-level-3 { 
            background-color: var(--danger-color); 
        } /* (ì‹¬ê°: ë¹¨ê°•) */
        /* â–²â–²â–² â­ï¸ (ìˆ˜ì •) ë¶€ìƒ ì²™ë„ë³„ ë±ƒì§€ ìƒ‰ìƒ â–²â–²â–² */
        
        /* â–¼â–¼â–¼ (ì‚­ì œ) ê¸°ì¡´ ë¶€ìƒ ì²™ë„ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ â–¼â–¼â–¼ */
        /* .injury-level-display { ... } ë“± ê´€ë ¨ ìŠ¤íƒ€ì¼ ì œê±°ë¨ */
        /* â–²â–²â–² (ì‚­ì œ) ê¸°ì¡´ ë¶€ìƒ ì²™ë„ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ â–²â–²â–² */

        .note-content { 
            font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap; word-break: break-word; 
            padding-right: 30px; 
        }
        
        /* ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .delete-note-btn {
            position: absolute;
            top: 10px; right: 10px;
            background: none; border: none;
            color: var(--danger-color);
            font-size: 1rem; cursor: pointer;
            opacity: 0.3; transition: opacity 0.2s;
            padding: 5px; z-index: 2;
        }
        .note-item:hover .delete-note-btn { opacity: 1; }
        .delete-note-btn:hover { color: #b91c1c; }
        .delete-note-btn:disabled { opacity: 0.2; cursor: not-allowed; }
        
        /* ë¡œë”©/ë°ì´í„° ì—†ìŒ */
        .loading, .no-data { text-align: center; padding: 30px; color: var(--text-secondary); }

        /* --- Toast Popup --- */
        .toast-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8); color: white; padding: 10px 18px; border-radius: 20px;
            font-size: 0.9rem; z-index: 1002; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
            pointer-events: none;
        }
        .toast-popup.show { opacity: 1; bottom: 40px; }
        .toast-popup.success { background-color: var(--success-color); }
        .toast-popup.error { background-color: var(--danger-color); }
        
        /* --- ëª¨ë°”ì¼ ë°˜ì‘í˜• --- */
        @media (max-width: 767px) {
            body { padding: 10px; }
            .header { flex-direction: column; align-items: stretch; padding: 15px; }
            .header h1 { font-size: 1.4rem; }
            .header-controls { flex-direction: column; align-items: stretch; }
            .chip { justify-content: space-between; }
            .btn { justify-content: center; }
            .card { padding: 15px; }
            .memo-layout { grid-template-columns: 1fr; }
            .note-history-list { max-height: 40vh; }
            .delete-note-btn { opacity: 0.7; }
            .injury-scale-options { flex-direction: column; align-items: flex-start; gap: 5px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-file-medical"></i> í•™ìƒ íŠ¹ì´ì‚¬í•­ ë©”ëª¨</h1>
        <div class="header-controls">
            <div class="chip">
                <label for="year-select"><i class="fas fa-calendar-alt"></i> í•™ë…„ë„</label>
                <select id="year-select">
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                </select>
            </div>
             <div class="chip">
                <label for="student-select"><i class="fas fa-user-graduate"></i> í•™ìƒ</label>
                <select id="student-select">
                    <option value="">- í•™ë…„ë„ ì„ íƒ -</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="memo-layout">
        <div class="card">
            <h4 class="card-title">ìƒˆ ë©”ëª¨ ì‘ì„±</h4>
            <div class="form-group">
                <label for="noteCategory">ì¹´í…Œê³ ë¦¬ (ì„ íƒ)</label>
                <select id="noteCategory">
                    <option value="">- ì—†ìŒ -</option>
                    <option value="ë¶€ìƒ">ë¶€ìƒ</option>
                    <option value="ë©˜íƒˆ">ë©˜íƒˆ</option>
                    <option value="ìƒë‹´">ìƒë‹´</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
            </div>
            
            <div class="form-group injury-scale-group" id="injuryScaleGroup">
                <label for="injuryLevel">ë¶€ìƒ ì²™ë„ (1: ê²½ë¯¸ ~ 3: ì‹¬ê°)</label>
                <div class="injury-scale-options">
                    <label>
                        <input type="radio" name="injury_level" value="1">
                        <span class="injury-level-1" style="color:var(--yellow-color); font-weight:600;"><i class="fas fa-check-circle"></i> 1 (ê²½ë¯¸)</span>
                    </label>
                    <label>
                        <input type="radio" name="injury_level" value="2">
                        <span class="injury-level-2" style="color:var(--warning-color); font-weight:600;"><i class="fas fa-exclamation-triangle"></i> 2 (ì¤‘ì¦)</span>
                    </label>
                    <label>
                        <input type="radio" name="injury_level" value="3">
                        <span class="injury-level-3" style="color:var(--danger-color); font-weight:600;"><i class="fas fa-times-circle"></i> 3 (ì‹¬ê°)</span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="noteContent">ë©”ëª¨ ë‚´ìš© (í•„ìˆ˜)</label>
                <textarea id="noteContent" rows="6" placeholder="í•™ìƒì˜ ë¶€ìƒ ìƒíƒœ, ë©˜íƒˆ ì´ìŠˆ, ìƒë‹´ ë‚´ìš© ë“±ì„ ìì„¸íˆ ê¸°ë¡í•˜ì„¸ìš”..."></textarea>
            </div>
            <button type="button" id="saveNoteBtn" class="btn btn-primary" disabled>
                <i class="fas fa-save"></i> ë©”ëª¨ ì €ì¥í•˜ê¸°
            </button>
        </div>
        
        <div class="card">
            <h4 class="card-title">ë©”ëª¨ ì´ë ¥</h4>
            <ul id="noteHistoryList">
                <p class="no-data" id="noteListPlaceholder">í•™ìƒì„ ì„ íƒí•˜ë©´ ë©”ëª¨ ì´ë ¥ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </ul>
        </div>
    </div>
</div>

<template id="noteItemTemplate">
    <li class="note-item" data-note-id="{{note_id}}">
        <div class="note-header">
            <div>
                <span class="teacher-name">ì‘ì„±ì</span>
                <span class="note-date">ë‚ ì§œ</span>
                </div>
            <span class="category" style="display: none;">ì¹´í…Œê³ ë¦¬</span>
        </div>
        <div class="note-content">
            ë©”ëª¨ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
        </div>
    </li>
</template>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ì„œë²„ ë° ì¸ì¦ ---
        const SVR_JUNGSI = 'https://supermax.kr';
        const LOGIN_PAGE = 'admin_login.html';

        // --- HTML ìš”ì†Œ ---
        const yearSelect = document.getElementById('year-select');
        const studentSelect = document.getElementById('student-select');
        const noteCategory = document.getElementById('noteCategory');
        const injuryScaleGroup = document.getElementById('injuryScaleGroup');
        const noteContent = document.getElementById('noteContent');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const noteHistoryList = document.getElementById('noteHistoryList');
        const noteListPlaceholder = document.getElementById('noteListPlaceholder');
        const noteItemTemplate = document.getElementById('noteItemTemplate');

        let studentListCache = [];
        let teacherList = [];
        let currentUser = null;
        let isManagement = false;

        // --- ì¸ì¦ í™•ì¸ ë° ê¶Œí•œ ì„¤ì • ---
        const getToken = () => localStorage.getItem('jwt_token');
        const token = getToken();
        if (!token) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); window.location.href = LOGIN_PAGE; return; }
        try {
            const payloadBase64Url = token.split('.')[1];
            const payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
            const decodedString = new TextDecoder().decode(Uint8Array.from(atob(payloadBase64), c => c.charCodeAt(0)));
            currentUser = JSON.parse(decodedString);
            console.log("ë¡œê·¸ì¸ ì‚¬ìš©ì:", currentUser);

            isManagement = currentUser && (
                (currentUser.position && ['ì›ì¥', 'ë¶€ì›ì¥', 'íŒ€ì¥'].includes(currentUser.position)) ||
                currentUser.role === 'admin'
            );
            console.log("ê´€ë¦¬ ê¶Œí•œ ì—¬ë¶€:", isManagement);

        } catch (e) {
            console.error('í† í° ì²˜ë¦¬ ì‹¤íŒ¨:', e); alert('ì¸ì¦ ì •ë³´ ì˜¤ë¥˜.'); window.location.href = LOGIN_PAGE; return;
        }

        // --- API í˜¸ì¶œ í•¨ìˆ˜ (ì¸ì¦ í¬í•¨) ---
        const apiCall = async (url, options = {}) => {
            const currentToken = getToken();
            if (!currentToken) { alert('ë¡œê·¸ì¸ ì„¸ì…˜ ë§Œë£Œ'); window.location.href = LOGIN_PAGE; throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ'); }
            options.headers = { ...options.headers, 'Authorization': `Bearer ${currentToken}` };
            try {
                const response = await fetch(url, options);
                if (response.status === 401) {
                     alert('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                     localStorage.removeItem('jwt_token'); window.location.href = LOGIN_PAGE; throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ');
                } else if (response.status === 403) {
                     alert('ì¸ì¦ ì˜¤ë¥˜ ë˜ëŠ” ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                     throw new Error('ê¶Œí•œ ì—†ìŒ');
                }
                if (!response.ok) {
                    let errorMsg = `HTTP ì˜¤ë¥˜ ${response.status}`; try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch (_) {} throw new Error(errorMsg);
                }
                if (response.status === 204) { return { success: true }; }
                return await response.json();
            } catch (error) {
                console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', url, error);
                if (error.message !== 'ë¡œê·¸ì¸ ë§Œë£Œ' && error.message !== 'ê¶Œí•œ ì—†ìŒ') {
                    showToast(`ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜: ${error.message}`, false);
                    throw new Error(error.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
                }
                throw error;
            }
        };

        // --- Toast Popup í•¨ìˆ˜ ---
        const showToast = (message, isSuccess = true) => {
             const el = document.createElement('div'); el.textContent = message; el.className = `toast-popup ${isSuccess ? 'success' : 'error'}`; document.body.appendChild(el); setTimeout(() => el.classList.add('show'), 10); setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 2500);
        };

        // --- ë‚ ì§œ í¬ë§·íŒ… í—¬í¼ ---
        const formatDateTime = (isoString) => {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                return date.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(/\. /g, '-').replace('.', '');
            } catch (e) { return isoString; }
        };

        // --- ì„ ìƒë‹˜ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ (ì´ë¦„ ë§¤ì¹­ìš©) ---
        const loadTeacherList = async () => {
             if (isManagement || currentUser.userid === 'sean8320') {
                 try {
                    const data = await apiCall(`${SVR_JUNGSI}/jungsi/admin/teachers-in-branch`);
                    if (data.success && data.teachers) {
                        teacherList = data.teachers;
                    }
                } catch (err) {
                     console.error('ì„ ìƒë‹˜ ëª©ë¡ ë¡œë”© ì˜¤ë¥˜ (ë¬´ì‹œí•¨):', err);
                }
             }
             if (!teacherList.some(t => t.userid === currentUser.userid)) {
                 teacherList.push({ userid: currentUser.userid, name: currentUser.name });
             }
             const uniqueTeacherMap = new Map(teacherList.map(t => [t.userid, t]));
             teacherList = Array.from(uniqueTeacherMap.values());
             console.log('ìµœì¢… ì„ ìƒë‹˜ ëª©ë¡ (ì´ë¦„ ë§¤ì¹­ìš©):', teacherList);
        };

        // --- 1. í•™ìƒ ëª©ë¡ ë¡œë“œ (ê´€ë¦¬ì/ì¼ë°˜ ë¶„ê¸° ì ìš©ë¨) ---
        const loadStudentList = async () => {
            const selectedYear = yearSelect.value;
            studentSelect.innerHTML = '<option value="">- í•™ìƒ ë¡œë”© ì¤‘ -</option>';
            studentSelect.disabled = true;
            saveNoteBtn.disabled = true;
            noteHistoryList.innerHTML = '<p class="no-data" id="noteListPlaceholder">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.</p>';

            try {
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/teacher/my-students?year=${selectedYear}`);

                if (data.success && data.students) {
                    studentListCache = data.students;
                    studentSelect.innerHTML = '<option value="">- í•™ìƒ ì„ íƒ -</option>';
                    studentListCache.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.account_id;
                        option.textContent = `${student.student_name} (${student.class_name || 'ë°˜ ë¯¸ë°°ì •'})`;
                        studentSelect.appendChild(option);
                    });
                    studentSelect.disabled = false;
                } else {
                    studentSelect.innerHTML = '<option value="">- í•™ìƒ ì—†ìŒ -</option>';
                }
            } catch (err) {
                console.error('í•™ìƒ ëª©ë¡ ë¡œë”© ì˜¤ë¥˜:', err);
                 if (err.message !== 'ê¶Œí•œ ì—†ìŒ' && err.message !== 'ë¡œê·¸ì¸ ë§Œë£Œ') {
                    studentSelect.innerHTML = '<option value="">- ë¡œë“œ ì˜¤ë¥˜ -</option>';
                    showToast(`í•™ìƒ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜: ${err.message}`, false);
                 }
            }
        };

        // --- 2. í•™ìƒ ì„ íƒ ì‹œ ë©”ëª¨ ì´ë ¥ ë¡œë“œ ---
        const loadStudentNotes = async () => {
            const studentId = studentSelect.value;
            if (!studentId) {
                noteHistoryList.innerHTML = '<p class="no-data" id="noteListPlaceholder">í•™ìƒì„ ì„ íƒí•˜ë©´ ë©”ëª¨ ì´ë ¥ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
                saveNoteBtn.disabled = true;
                return;
            }
            saveNoteBtn.disabled = false;
            noteHistoryList.innerHTML = '<p class="loading"><i class="fas fa-spinner fa-spin"></i> ë©”ëª¨ ë¡œë”© ì¤‘...</p>';
            try {
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/teacher/notes/${studentId}`);
                if (data.success && data.notes) {
                    renderNoteList(data.notes);
                } else {
                    noteHistoryList.innerHTML = `<p class="no-data">ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨: ${data.message || 'ì˜¤ë¥˜'}</p>`;
                }
            } catch (err) {
                 console.error('í•™ìƒ ë©”ëª¨ ë¡œë”© ì˜¤ë¥˜:', err);
                 if (err.message !== 'ê¶Œí•œ ì—†ìŒ' && err.message !== 'ë¡œê·¸ì¸ ë§Œë£Œ') {
                    noteHistoryList.innerHTML = `<p class="no-data">ì˜¤ë¥˜ ë°œìƒ: ${err.message}</p>`;
                 }
            }
        };

        // --- 3. ë©”ëª¨ ì´ë ¥ ë Œë”ë§ í•¨ìˆ˜ ---
        const renderNoteList = (notes) => {
            noteHistoryList.innerHTML = '';
            if (notes.length === 0) {
                noteHistoryList.innerHTML = '<p class="no-data" id="noteListPlaceholder">ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            notes.forEach(note => {
                const noteCard = createNoteCard(note);
                noteHistoryList.appendChild(noteCard);
            });
        };

        // --- 3-1. ê°œë³„ ë©”ëª¨ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ (â­ï¸ ë¶€ìƒ ì²™ë„/ì‚­ì œ ë²„íŠ¼ ìˆ˜ì •) ---
        const createNoteCard = (note) => {
             const template = document.getElementById('noteItemTemplate');
             const item = template.content.cloneNode(true).firstElementChild;
             item.dataset.noteId = note.note_id;

             let teacherName = note.teacher_userid || 'ì•Œ ìˆ˜ ì—†ìŒ';
             const teacher = teacherList.find(t => t.userid === note.teacher_userid);
             if (teacher && teacher.name) {
                 teacherName = teacher.name;
             }
             item.querySelector('.teacher-name').textContent = teacherName;

             item.querySelector('.note-date').textContent = formatDateTime(note.note_date);
             item.querySelector('.note-content').textContent = note.note_content || '(ë‚´ìš© ì—†ìŒ)';

             // â–¼â–¼â–¼ ì¹´í…Œê³ ë¦¬ ë° ë¶€ìƒ ì²™ë„ ìƒ‰ìƒ í‘œì‹œ â–¼â–¼â–¼
             const categorySpan = item.querySelector('.category');
             if (note.category) {
                 categorySpan.textContent = note.category;
                 categorySpan.style.display = 'inline-block';

                 if (note.category === 'ë¶€ìƒ') {
                     const level = parseInt(note.injury_level, 10);
                     if (level === 1) categorySpan.classList.add('injury-level-1');
                     else if (level === 2) categorySpan.classList.add('injury-level-2');
                     else if (level === 3) categorySpan.classList.add('injury-level-3');
                     else categorySpan.style.backgroundColor = 'var(--danger-color)';
                 }
                 else if (note.category === 'ë©˜íƒˆ') categorySpan.style.backgroundColor = '#60a5fa'; // íŒŒë‘
                 else if (note.category === 'ìƒë‹´') categorySpan.style.backgroundColor = 'var(--success-color)'; // ì´ˆë¡
                 else categorySpan.style.backgroundColor = 'var(--warning-color)'; // ê¸°íƒ€ (ì£¼í™©)
             }
             // â–²â–²â–² ì¹´í…Œê³ ë¦¬ í‘œì‹œ ë¡œì§ â–²â–²â–²

             // â–¼â–¼â–¼ ì‚­ì œ ë²„íŠ¼ ë™ì  ì¶”ê°€ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ â–¼â–¼â–¼
             if (isManagement || currentUser.userid === note.teacher_userid) {
                 const deleteBtn = document.createElement('button');
                 deleteBtn.type = 'button';
                 deleteBtn.className = 'delete-note-btn';
                 deleteBtn.title = 'ë©”ëª¨ ì‚­ì œ';
                 deleteBtn.innerHTML = '<i class="fas fa-times-circle"></i>';

                 // â­ï¸ (ìˆ˜ì •) deleteNote í•¨ìˆ˜ì— ì¹´í…Œê³ ë¦¬ ì •ë³´(note.category) ì „ë‹¬
                 deleteBtn.addEventListener('click', (e) => {
                     e.stopPropagation();
                     deleteNote(note.note_id, item, note.category); // â­ï¸ note.category ì¶”ê°€
                 });
                 item.appendChild(deleteBtn);
             }
             // â–²â–²â–² ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ â–²â–²â–²

             return item;
        };

        // --- 4. ìƒˆ ë©”ëª¨ ì €ì¥ í•¨ìˆ˜ (â­ï¸ ë¶€ìƒ ì²™ë„ ê°’ ì „ì†¡ ì¶”ê°€) ---
        const saveNewNote = async () => {
            const studentId = studentSelect.value;
            const content = noteContent.value.trim();
            const category = noteCategory.value;

            let injuryLevel = null;
            if (category === 'ë¶€ìƒ') {
                const checkedRadio = document.querySelector('input[name="injury_level"]:checked');
                if (checkedRadio) {
                    injuryLevel = checkedRadio.value;
                }
            }

            if (!studentId) { showToast('ë©”ëª¨ë¥¼ ì €ì¥í•  í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false); return; }
            if (!content) { showToast('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', false); noteContent.focus(); return; }

            saveNoteBtn.disabled = true;
            saveNoteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...';
            try {
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/teacher/notes/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_account_id: parseInt(studentId),
                        note_content: content,
                        category: category || null,
                        injury_level: injuryLevel
                    })
                });
                if (data.success && data.insertedNote) {
                    showToast(`âœ… ${data.message || 'ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'}`, true);

                    if (data.insertedNote.teacher_userid === currentUser.userid) {
                         const me = teacherList.find(t => t.userid === currentUser.userid);
                         data.insertedNote.teacher_name = me ? me.name : currentUser.name;
                    }

                    const newNoteCard = createNoteCard(data.insertedNote);
                    const placeholder = document.getElementById('noteListPlaceholder');
                    if (placeholder) placeholder.style.display = 'none';
                    noteHistoryList.prepend(newNoteCard);

                    noteContent.value = '';
                    noteCategory.value = '';
                    noteCategory.dispatchEvent(new Event('change'));
                } else {
                    showToast(`âŒ ì €ì¥ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, false);
                }
            } catch (err) {
                 if (err.message !== 'ê¶Œí•œ ì—†ìŒ' && err.message !== 'ë¡œê·¸ì¸ ë§Œë£Œ') {
                    showToast(`âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`, false);
                 }
            } finally {
                 saveNoteBtn.disabled = false;
                 saveNoteBtn.innerHTML = '<i class="fas fa-save"></i> ë©”ëª¨ ì €ì¥í•˜ê¸°';
            }
        };

        // --- 5. ë©”ëª¨ ì‚­ì œ í•¨ìˆ˜ ---
        // â­ï¸ (ìˆ˜ì •) category íŒŒë¼ë¯¸í„° ì¶”ê°€ ë° confirm ë©”ì‹œì§€ ë¶„ê¸°
        const deleteNote = async (noteId, noteElement, category) => { // â­ï¸ category ì¶”ê°€
            if (!noteId || !noteElement) return;
            const noteText = noteElement.querySelector('.note-content').textContent.substring(0, 20);

            // â­ï¸ confirm ë©”ì‹œì§€ ì¡°ê±´ë¶€ ìƒì„±
            let confirmMsg = `[${noteText}...] ë©”ëª¨ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            if (category === 'ë¶€ìƒ') {
                confirmMsg += ' (ë¶€ìƒ ì´ë ¥ì´ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤)'; // 'ë¶€ìƒ'ì¼ ë•Œë§Œ ê²½ê³  ì¶”ê°€
            }

            // â­ï¸ ìˆ˜ì •ëœ ë©”ì‹œì§€ë¡œ confirm í˜¸ì¶œ
            if (!confirm(confirmMsg)) {
                return;
            }

            const deleteBtn = noteElement.querySelector('.delete-note-btn');
            if (deleteBtn) deleteBtn.disabled = true;

            try {
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/teacher/notes/delete/${noteId}`, {
                    method: 'DELETE'
                });

                if (data.success) {
                    showToast('ğŸ—‘ï¸ ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', true);
                    noteElement.style.opacity = 0;
                    setTimeout(() => {
                        noteElement.remove();
                        if (noteHistoryList.querySelectorAll('li.note-item').length === 0) {
                             noteHistoryList.innerHTML = '<p class="no-data" id="noteListPlaceholder">ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        }
                    }, 300);
                } else {
                     showToast(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, false);
                     if (deleteBtn) deleteBtn.disabled = false;
                }
            } catch (err) {
                 console.error('ë©”ëª¨ ì‚­ì œ ì˜¤ë¥˜:', err);
                 if (err.message !== 'ê¶Œí•œ ì—†ìŒ' && err.message !== 'ë¡œê·¸ì¸ ë§Œë£Œ') {
                    showToast(`âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`, false);
                 }
                 if (deleteBtn) deleteBtn.disabled = false;
            }
        };

        // --- 6. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        yearSelect.addEventListener('change', loadStudentList);
        studentSelect.addEventListener('change', () => {
            loadStudentNotes();
            saveNoteBtn.disabled = !studentSelect.value;
        });
        saveNoteBtn.addEventListener('click', saveNewNote);

        noteCategory.addEventListener('change', () => {
            if (noteCategory.value === 'ë¶€ìƒ') {
                injuryScaleGroup.style.display = 'block';
            } else {
                injuryScaleGroup.style.display = 'none';
                document.querySelectorAll('input[name="injury_level"]').forEach(radio => {
                    radio.checked = false;
                });
            }
        });

        // --- 7. ì´ˆê¸° ì‹¤í–‰ ---
        const initializePage = async () => {
            await loadTeacherList();
            await loadStudentList();
        };
        initializePage();
    });
</script>