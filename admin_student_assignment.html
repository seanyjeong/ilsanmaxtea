<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>학생 반 배정 관리 (관리자)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb; --primary-dark:#1d4ed8;
            --light-bg: #f8fafc; --card-bg: #ffffff;
            --border-color: #e2e8f0; --text-primary:#1e293b; --text-secondary:#475569;
            --danger-color: #ef4444; --success-color: #10b981; --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light-bg); padding: 20px; margin: 0; line-height: 1.5; color: var(--text-primary); }
        .container { max-width: 95%; margin: 0 auto; }

        /* ---------- Header ---------- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            gap: 12px; flex-wrap: wrap;
            background: var(--card-bg); padding: 16px 18px; border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.6rem; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .chip { display: inline-flex; align-items: center; gap: 6px; background: var(--light-bg); padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        .chip label { font-size: .9rem; color: var(--text-secondary); white-space: nowrap; }
        select { padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: #fff; font-size: .95rem; min-width: 150px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: none; border-radius: 8px; font-weight: 600; font-size: .9rem; cursor: pointer; transition: .2s; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; }

        /* ---------- Card ---------- */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); padding: 20px; }

        /* ---------- Table ---------- */
        .table-container { 
            /* ⭐️ overflow-x: auto; 제거됨 */
            border: 1px solid var(--border-color); border-radius: 8px; margin-top: 15px; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            table-layout: fixed; /* ⭐️ 고정 레이아웃 사용 */
        }
        th, td { 
            padding: 10px 12px; border-bottom: 1px solid var(--border-color); 
            text-align: left; vertical-align: middle; 
            /* ⭐️ 글자 작아질 때 줄바꿈 대신 ... 처리 */
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        th { background-color: #f1f5f9; font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: #f8fafc; }
        
        td input[type="text"], td select {
            width: 100%; min-width: 0; /* ⭐️ 최소 너비 제거 */
            padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: .9rem;
            background-color: #fff;
        }
        td input[type="text"]:focus, td select:focus {
            outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        /* ⭐️ 기본 컬럼 너비 (비율로) */
        th:nth-child(1), td:nth-child(1) { width: 22%; } /* 학생 이름 */
        th:nth-child(2), td:nth-child(2) { width: 23%; } /* 현재 배정 */
        th:nth-child(3), td:nth-child(3) { width: 25%; } /* 반 이름 입력 */
        th:nth-child(4), td:nth-child(4) { width: 30%; } /* 담당 선생님 선택 */

        /* 로딩/데이터 없음 메시지 */
        .loading, .no-data { text-align: center; padding: 30px; color: var(--text-secondary); }

        /* --- Toast Popup --- */
        .toast-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8); color: white; padding: 10px 18px; border-radius: 20px;
            font-size: 0.9rem; z-index: 1002; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
            pointer-events: none;
        }
        .toast-popup.show { opacity: 1; bottom: 40px; }
        .toast-popup.success { background-color: var(--success-color); }
        .toast-popup.error { background-color: var(--danger-color); }

        /* --- ⭐️⭐️⭐️ 모바일 반응형 CSS 수정 (글씨 축소) ⭐️⭐️⭐️ --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header {
                flex-direction: column; align-items: stretch; padding: 15px;
            }
            .header h1 { font-size: 1.4rem; }
            .header-controls { flex-direction: column; align-items: stretch; }
            .chip { justify-content: space-between; }
            .btn { justify-content: center; }
            
            .card { padding: 15px; }
            
            /* ⭐️ 테이블 컨테이너 스크롤 제거! */
            .table-container {
                overflow-x: hidden; 
            }
            table {
                table-layout: fixed; /* 고정 레이아웃 유지 */
                width: 100%; /* 너비 100% */
                /* min-width 제거 */
            }
            
            /* ⭐️ 테이블 폰트, 여백 대폭 축소 */
            th, td {
                font-size: 12px; /* ⭐️ 글자 크기 작게! */
                padding: 8px 6px; /* ⭐️ 상하좌우 여백 줄이기 */
                /* ⭐️ 줄바꿈 강제 (필요시) */
                /* white-space: normal; */ 
                /* ⭐️ 단어 기준 줄바꿈 (이름 깨짐 방지) */
                word-break: keep-all; 
            }
            th { font-size: 11px; } /* 헤더는 더 작게 */

            /* ⭐️ 입력칸, 선택칸도 작게 */
            td input[type="text"], td select {
                font-size: 12px; /* ⭐️ 글자 크기 작게! */
                padding: 5px 4px; /* ⭐️ 여백 줄이기 */
            }
            
            /* ⭐️ 컬럼 너비 비율 재조정 (모바일용) */
            th:nth-child(1), td:nth-child(1) { width: 25%; } /* 학생 이름 */
            th:nth-child(2), td:nth-child(2) { width: 20%; } /* 현재 배정 */
            th:nth-child(3), td:nth-child(3) { width: 25%; } /* 반 이름 */
            th:nth-child(4), td:nth-child(4) { width: 30%; } /* 담당 선생님 */
        }
        
        /* ⭐️ Z폴드 등 초소형 화면 대응 (360px 이하) */
        @media (max-width: 360px) {
            th, td {
                font-size: 10px; /* ⭐️ 글자 더 작게! */
                padding: 6px 4px; /* ⭐️ 여백 더 줄이기 */
            }
            th { font-size: 9px; }
            td input[type="text"], td select {
                font-size: 10px; /* ⭐️ 글자 더 작게! */
                padding: 4px 3px; /* ⭐️ 여백 더 줄이기 */
            }
        }
        /* --- ⭐️⭐️⭐️ 모바일 반응형 CSS 끝 ⭐️⭐️⭐️ --- */
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-chalkboard-teacher"></i> 학생 반 배정 관리</h1>
        <div class="header-controls">
            <div class="chip">
                <label for="year-select"><i class="fas fa-calendar-alt"></i> 대상 학년도</label>
                <select id="year-select">
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                </select>
            </div>
            <button type="button" id="saveAssignmentsBtn" class="btn btn-primary" disabled>
                <i class="fas fa-save"></i> 전체 저장하기
            </button>
        </div>
    </div>

    <div class="card">
        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">
            각 학생에게 배정할 **반 이름**과 **담당 선생님**을 선택하고 '전체 저장하기' 버튼을 누르세요.
        </p>
        <div class="table-container">
            <table id="assignmentTable">
                <thead>
                    <tr>
                        <th>학생 이름</th>
                        <th>현재 배정 (반 / 선생님ID)</th>
                        <th>반 이름 (수정/입력)</th>
                        <th>담당 선생님 (수정/선택)</th>
                    </tr>
                </thead>
                <tbody id="assignmentTbody">
                    <tr>
                        <td colspan="4" class="loading"><i class="fas fa-spinner fa-spin"></i> 학생 목록 로딩 중...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<template id="teacherOptionsTemplate">
    <option value="">- 선생님 선택 -</option>
    </template>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 서버 및 인증 ---
        const SVR_JUNGSI = 'https://supermax.kr';
        // ⭐️ 로그인 페이지 경로 확인 (admin_login.html 이 맞는지 확인)
        const LOGIN_PAGE = 'admin_login.html';

        // --- HTML 요소 ---
        const yearSelect = document.getElementById('year-select');
        const assignmentTbody = document.getElementById('assignmentTbody');
        const saveAssignmentsBtn = document.getElementById('saveAssignmentsBtn');
        const teacherOptionsTemplate = document.getElementById('teacherOptionsTemplate');

        let currentStudents = [];
        let teacherList = [];
        let currentUser = null; // ⭐️ currentUser 변수 추가

        // --- 인증 확인 (직급 또는 sean8320) ---
        const getToken = () => localStorage.getItem('jwt_token');
        const token = getToken();
        if (!token) { alert('로그인이 필요합니다.'); window.location.href = LOGIN_PAGE; return; }
        try {
            const payloadBase64Url = token.split('.')[1];
            const payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
            const decodedString = new TextDecoder().decode(Uint8Array.from(atob(payloadBase64), c => c.charCodeAt(0)));
            currentUser = JSON.parse(decodedString); // ⭐️ currentUser에 payload 저장
            console.log("로그인 사용자:", currentUser);

            // ▼▼▼ 권한 확인 로직 수정 ▼▼▼
            const hasPermission = currentUser && (
                (currentUser.position && ['원장', '부원장', '팀장'].includes(currentUser.position)) ||
                currentUser.userid === 'sean8320'
            );

            if (!hasPermission) {
                 alert('반 배정 관리 페이지에 접근할 권한(원장/부원장/팀장)이 없습니다.');
                 // 이전 페이지로 돌려보내거나, 접근 불가 메시지 표시
                 assignmentTbody.innerHTML = `<tr><td colspan="4" class="no-data" style="color:var(--danger-color);">접근 권한 없음</td></tr>`;
                 // 모든 컨트롤 비활성화
                 yearSelect.disabled = true;
                 saveAssignmentsBtn.disabled = true;
                 // 또는 다른 페이지로 리다이렉션
                 // window.location.href = 'index.html'; // 예시: 메인 페이지로
                 return; // 스크립트 실행 중단
            }
            console.log("반 배정 관리 권한 확인됨. 페이지 로딩 계속...");
            // ▲▲▲ 권한 확인 로직 수정 끝 ▲▲▲

        } catch (e) {
            console.error('토큰 처리 실패:', e); alert('인증 정보 오류.'); window.location.href = LOGIN_PAGE; return;
        }

        // --- API 호출 함수 (인증 포함) ---
        const apiCall = async (url, options = {}) => {
            // ... (이하 apiCall 함수 코드는 기존과 동일) ...
            const currentToken = getToken();
            if (!currentToken) { alert('로그인 세션 만료'); window.location.href = LOGIN_PAGE; throw new Error('로그인 만료'); }
            options.headers = { ...options.headers, 'Authorization': `Bearer ${currentToken}` };
            try {
                const response = await fetch(url, options);
                if (response.status === 401 || response.status === 403) {
                     alert('인증 오류 또는 권한 없음'); localStorage.removeItem('jwt_token'); window.location.href = LOGIN_PAGE; throw new Error('인증 오류');
                }
                if (!response.ok) {
                    let errorMsg = `HTTP 오류 ${response.status}`; try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch (_) {} throw new Error(errorMsg);
                }
                if (response.status === 204) { return { success: true }; }
                return await response.json();
            } catch (error) {
                console.error('API 호출 실패:', url, error);
                if (error.message !== '로그인 만료' && error.message !== '인증 오류') {
                    showToast(`네트워크 또는 서버 오류: ${error.message}`, false); // Toast 추가
                    throw new Error(error.message || '네트워크 오류');
                }
                throw error;
            }
        };

        // --- Toast Popup 함수 ---
        const showToast = (message, isSuccess = true) => { /* ... (기존과 동일) ... */
             const el = document.createElement('div'); el.textContent = message; el.className = `toast-popup ${isSuccess ? 'success' : 'error'}`; document.body.appendChild(el); setTimeout(() => el.classList.add('show'), 10); setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 2500);
        };

        // --- 선생님 목록 로드 및 템플릿 채우기 함수 ---
        const loadTeacherList = async () => { /* ... (기존과 동일) ... */
             try {
                // ⭐️ API 경로 확인: /jungsi/admin/teachers-in-branch 는 sean8320 전용 API임
                //    sean8320이 아닌 원장/팀장이 이 페이지에 접근 시, 이 API 호출에서 403 에러 발생 가능성 있음
                //    -> 해결: 이 API도 권한 체크를 직급 기반으로 바꾸거나, 공개 API로 변경 필요
                //    -> 임시 해결: try-catch로 감싸서 에러 발생 시 토스트만 띄우도록 함
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/admin/teachers-in-branch`);
                if (data.success && data.teachers) {
                    teacherList = data.teachers;
                    const optionsHtml = teacherList.map(teacher =>
                        `<option value="${teacher.userid}">${teacher.name} (${teacher.userid})</option>`
                    ).join('');
                    teacherOptionsTemplate.innerHTML += optionsHtml;
                    console.log('선생님 목록 로드 완료:', teacherList);
                } else {
                    showToast('선생님 목록 로드에 실패했습니다. (API 응답 오류)', false);
                }
            } catch (err) {
                 console.error('선생님 목록 로딩 오류:', err);
                 // 403 에러 발생 시에도 페이지가 멈추지 않도록 처리
                 if (err.message !== '권한 없음') { // 권한 없음 alert는 apiCall에서 이미 띄움
                    showToast(`선생님 목록 로드 오류: ${err.message}`, false);
                 }
                 // 선생님 목록 로드 실패 시에도 빈 옵션만이라도 있도록 함
                 teacherOptionsTemplate.innerHTML = '<option value="">- 로드 실패 -</option>';
            }
        };

        // --- 학생 목록 로드 함수 ---
        const loadStudentList = async () => { /* ... (기존과 동일) ... */
            const selectedYear = yearSelect.value;
            assignmentTbody.innerHTML = `<tr><td colspan="4" class="loading"><i class="fas fa-spinner fa-spin"></i> ${selectedYear}학년도 학생 목록 로딩 중...</td></tr>`;
            saveAssignmentsBtn.disabled = true;
            currentStudents = [];
            try {
                // ⭐️ API 경로 확인: /jungsi/admin/students-for-assignment 도 sean8320 전용 API임
                //    -> 해결: 이 API도 권한 체크를 직급 기반으로 바꾸거나, 공개 API로 변경 필요
                //    -> 임시 해결: try-catch
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/admin/students-for-assignment?year=${selectedYear}`);
                if (data.success && data.students) {
                    currentStudents = data.students;
                    renderStudentList(currentStudents);
                    saveAssignmentsBtn.disabled = false;
                } else {
                    assignmentTbody.innerHTML = `<tr><td colspan="4" class="no-data">목록 로딩 실패: ${data.message || '오류'}</td></tr>`;
                }
            } catch (err) {
                console.error('학생 목록 로딩 오류:', err);
                if (err.message !== '권한 없음') {
                    assignmentTbody.innerHTML = `<tr><td colspan="4" class="no-data">오류 발생: ${err.message}</td></tr>`;
                }
                // 권한 없음 시에는 이미 alert + 테이블에 메시지 표시됨
            }
        };


        // --- 학생 목록 테이블 렌더링 함수 ---
        const renderStudentList = (students) => { /* ... (기존과 동일) ... */
            assignmentTbody.innerHTML = '';
            if (students.length === 0) {
                assignmentTbody.innerHTML = `<tr><td colspan="4" class="no-data">해당 학년도에 등록된 학생이 없습니다.</td></tr>`;
                return;
            }
            const teacherOptionsHtml = teacherOptionsTemplate.innerHTML;
            students.forEach(student => {
                const tr = document.createElement('tr');
                tr.dataset.accountId = student.account_id;
                const currentAssignmentText = (student.class_name && student.teacher_userid)
                    ? `${student.class_name} / ${student.teacher_userid}`
                    : '<span style="color:var(--text-secondary); font-style:italic;">미배정</span>';
                tr.innerHTML = `
                    <td>${student.student_name || '이름 없음'} (${student.userid || student.account_id})</td>
                    <td>${currentAssignmentText}</td>
                    <td><input type="text" name="class_name" value="${student.class_name || ''}" placeholder="예: 정시 A반"></td>
                    <td>
                        <select name="teacher_userid">
                            ${teacherOptionsHtml}
                        </select>
                    </td>
                `;
                const teacherSelect = tr.querySelector('select[name="teacher_userid"]');
                if (student.teacher_userid) {
                    // 드물게 teacherList 로드 전에 render가 호출될 수 있으므로 방어 코드 추가
                    if (teacherList.some(t => t.userid === student.teacher_userid)) {
                         teacherSelect.value = student.teacher_userid;
                    } else {
                         console.warn(`Student ${student.account_id} assigned teacher ${student.teacher_userid} not found in list.`);
                    }
                }
                assignmentTbody.appendChild(tr);
            });
        };

        // --- 배정 정보 저장 함수 ---
        const saveAssignments = async () => { /* ... (기존과 동일, API 권한은 백엔드에서 체크) ... */
             if (currentStudents.length === 0) { showToast('저장할 학생 목록이 없습니다.', false); return; }
            saveAssignmentsBtn.disabled = true;
            saveAssignmentsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 저장 중...';
            const selectedYear = yearSelect.value;
            const assignmentsToSave = [];
            assignmentTbody.querySelectorAll('tr[data-account-id]').forEach(tr => { // data-account-id가 있는 tr만 순회
                const accountId = tr.dataset.accountId;
                const classNameInput = tr.querySelector('input[name="class_name"]');
                const teacherSelect = tr.querySelector('select[name="teacher_userid"]');
                if (accountId && classNameInput && teacherSelect) {
                    const className = classNameInput.value.trim();
                    const teacherId = teacherSelect.value;
                    // ⭐️ 반 이름 또는 담당 선생님이 설정된 경우만 저장 목록에 포함
                    if (className || teacherId) {
                        assignmentsToSave.push({
                            student_account_id: parseInt(accountId),
                            // ⭐️ 둘 다 비어있을 경우를 대비해 null 처리 확실히
                            class_name: className || null,
                            teacher_userid: teacherId || null
                        });
                    }
                }
            });
            console.log('Saving assignments:', assignmentsToSave);

            // ⭐️ 저장할 내용이 하나도 없어도 API 호출 시도 (백엔드에서 빈 배열 처리 가능)
            // if (assignmentsToSave.length === 0) { ... } -> 이 부분 제거

            try {
                 // ⭐️ API 경로 확인: /jungsi/admin/save-assignments 도 sean8320 전용 API
                 //    -> 해결: 이 API도 권한 체크를 직급 기반으로 변경 필요
                 //    -> 임시 해결: try-catch
                const data = await apiCall(`${SVR_JUNGSI}/jungsi/admin/save-assignments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        year: selectedYear,
                        assignments: assignmentsToSave
                    })
                });
                if (data.success) {
                    showToast('✅ 배정 정보가 성공적으로 저장되었습니다.', true);
                    loadStudentList(); // 저장 후 목록 새로고침
                }
                // API 내부 실패 시 apiCall에서 이미 alert 띄움 (success: false)
            } catch (err) {
                console.error('배정 정보 저장 오류:', err);
                 // 권한 없음 외 에러만 토스트 표시 (apiCall에서 이미 alert 띄움)
                 if (err.message !== '권한 없음') {
                    showToast(`❌ 저장 중 오류 발생: ${err.message}`, false);
                 }
            } finally {
                saveAssignmentsBtn.disabled = false;
                saveAssignmentsBtn.innerHTML = '<i class="fas fa-save"></i> 전체 저장하기';
            }
        };

        // --- 초기 실행 함수 ---
        const initializePage = async () => {
            await loadTeacherList(); // 1. 선생님 목록 먼저 로드
            await loadStudentList(); // 2. 학생 목록 로드
        };

        // --- 이벤트 리스너 연결 ---
        yearSelect.addEventListener('change', loadStudentList);
        saveAssignmentsBtn.addEventListener('click', saveAssignments);

        // --- 초기 로드 실행 ---
        initializePage();

    });
</script>

</body>
</html>